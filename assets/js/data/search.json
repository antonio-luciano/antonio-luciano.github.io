[ { "title": "Como se proteger contra abusos de Device Code Flow", "url": "/posts/AuthenticationFlow/", "categories": "Seguran√ßa, Microsoft Entra ID", "tags": "Microsoft Entra ID, Azure AD, Device Code Flow, Seguran√ßa na Nuvem, Conditional Access", "date": "2025-05-17 22:00:00 -0300", "snippet": " Ol√°, pessoal!Viram que a Microsoft criou uma nova Pol√≠tica de Acesso Condicional em seus Tenants?A pol√≠tica foi criada para bloquear Device Code Flow, que neste post voc√™s v√£o entender melhor do ...", "content": " Ol√°, pessoal!Viram que a Microsoft criou uma nova Pol√≠tica de Acesso Condicional em seus Tenants?A pol√≠tica foi criada para bloquear Device Code Flow, que neste post voc√™s v√£o entender melhor do que se trata. Mas fique tranquilo, a pol√≠tica foi criada como Report-only, por√©m, ap√≥s 45 dias da cria√ß√£o da pol√≠tica em seu tenant, ela ser√° alterada para On.Fique atento, analise os logs relecionadas a esta pol√≠tica para decidir como voc√™ ir√° mant√™-la em seu ambiente.A seguran√ßa de identidades na nuvem tornou-se um pilar essencial para qualquer organiza√ß√£o moderna. Um dos vetores de ataque recentemente explorado por atores maliciosos √© o Device Code Flow, uma alternativa de autentica√ß√£o amplamente utilizada por dispositivos sem navegador, como CLI e aplicativos IoT.Um exemplo recente e not√≥rio √© a campanha conduzida pelo grupo STORM-2372, que abusou do Device Code Flow para comprometer contas corporativas, mesmo com autentica√ß√£o multifator (MFA) habilitada.üß© O que √© o Device Code Flow?O Device Code Flow √© um fluxo de autentica√ß√£o suportado pelo protocolo OAuth 2.0, projetado para dispositivos sem interface gr√°fica/interativa ou sem navegador (ex: Terminal, Smart TVs, CLI).Neste fluxo, o usu√°rio √© instru√≠do a visitar um endere√ßo (ex: https://microsoft.com/devicelogin) em um navegador e inserir um c√≥digo fornecido pelo dispositivo. Isso permite a autentica√ß√£o em segundo plano, sem que o dispositivo em si manipule diretamente as credenciais.Acredito que muitos aqui, j√° utilizaram para autenticar no Microsoft Azure, Netflix, Apple TV+ e assim por diante.Exemplo de uso:az login --use-device-codeEsse comando exibe um c√≥digo e solicita que o usu√°rio v√° at√© um navegador para concluir a autentica√ß√£o. Ap√≥s a conclus√£o, o terminal (ou aplicativo) recebe o token de acesso e pode operar com os privil√©gios do usu√°rio autenticado.‚ö†Ô∏è Como o STORM-2372 Explorou o Device Code FlowO grupo de amea√ßa STORM-2372 (tamb√©m conhecido como Midnight Blizzard, Nobelium, ou APT29) tem abusado do fluxo de c√≥digo do dispositivo como parte de sua cadeia de ataque para evitar bloqueios comuns impostos por MFA e outros mecanismos de prote√ß√£o.A t√©cnica funciona da seguinte forma: O ator malicioso inicia o Device Code Flow de forma programada, por exemplo usando az login --use-device-code ou outras APIs; Exibe um c√≥digo √∫nico de autentica√ß√£o; O atacante envia esse c√≥digo para a v√≠tima, muitas vezes com engenharia social sofisticada, induzindo-a concluir o login (acreditando que se trata de um processo leg√≠timo); Ao concluir a autentica√ß√£o com o c√≥digo, o atacante recebe um token v√°lido, ‚Äúbypassando MFA‚Äù, pois a v√≠tima j√° fez a autentica√ß√£o com sucesso;Por que esse ataque √© eficaz? MFA n√£o √© suficiente: Se a v√≠tima insere o c√≥digo e autentica com MFA, o token ainda vai para o atacante; Dif√≠cil de detectar: O fluxo parece leg√≠timo, e pode usar aplica√ß√µes registradas que n√£o levantam suspeitas; Token de longa dura√ß√£o: Em alguns casos, o token tem validade prolongada, permitindo persist√™ncia no ambiente;üõ°Ô∏è Como se Proteger: Bloqueando o Device Code FlowA Microsoft permite que administradores bloqueiem ou restrinjam o uso do Device Code Flow por meio de pol√≠ticas de acesso condicional gerenciadas no Entra ID (Azure AD).üìå O que s√£o Pol√≠ticas Gerenciadas?Pol√≠ticas gerenciadas s√£o um novo recurso que permite aplicar configura√ß√µes de seguran√ßa automatizadas e baseadas em recomenda√ß√µes da Microsoft, como o bloqueio do Device Code Flow, prote√ß√£o contra autentica√ß√£o herdada (legacy), entre outras. S√£o pol√≠ticas predefinidas que permitem aos administradores simplificar a gest√£o da seguran√ßa, oferecendo op√ß√µes de configura√ß√£o e modifica√ß√µes b√°sicas. Estas pol√≠ticas visam garantir um n√≠vel b√°sico de seguran√ßa para todos os tenants, mesmo aqueles que n√£o t√™m licenciamento Microsoft Entra ID P1 ou P2.N√£o conhecia? Da uma olhada: Microsoft-managed Conditional Access policiesVeja que a Microsoft criou esta pol√≠tica como Report-only no seu tenant, para que voc√™ possa analisar os logs e ter este tipo de prote√ß√£o para sua organiza√ß√£o. √â importante voc√™ monitorar se este tipo de autentica√ß√£o √© utilizado em seu ambiente. Caso n√£o, habilite a politica. Caso sim, tamb√©m habilite a pol√≠tica (rs), e trate a aplica√ß√£o/recurso que precisa utilizar este tipo de autentica√ß√£o, como exce√ß√£o.‚úÖ Etapas para Bloquear o Device Code Flow:Voc√™ tamb√©m pode criar a Conditional Access Policy manualmente: Acesse o portal do Microsoft Entra: https://entra.microsoft.com V√° para Protection &gt; Conditional Access &gt; Policies; Crie uma nova pol√≠tica, defina os usu√°rios, em Target selecione todos os recursos (All cloud apps); Em Conditions selecione Authentication flows; Marque a op√ß√£o Device code flow e Save; Habilite a pol√≠tica (On);Essa pol√≠tica bloquear√° tentativas de autentica√ß√£o usando esse fluxo, exceto para aplicativos e usu√°rios explicitamente permitidos.Mais informa√ß√µes em: Block authentication flows with Conditional Access policyüìå Considera√ß√µes importantes: O bloqueio √© recomendado para organiza√ß√µes que n√£o utilizam dispositivos ou aplicativos que dependem do Device Code Flow. Caso existam aplica√ß√µes leg√≠timas que dependem deste fluxo (ex: Azure CLI, Power BI Gateway), √© poss√≠vel criar exce√ß√µes espec√≠ficas usando uma pol√≠tica personalizada de acesso condicional. Verifique os logs de autentica√ß√£o para avaliar o uso atual desse fluxo antes de aplicar o bloqueio de forma ampla.üîç Como Identificar o Uso do Device Code FlowVoc√™ pode usar o Sign-in Logs do Microsoft Entra ID para encontrar eventos onde o Authentication Protocol √© definido como Device Code.Exemplo via Portal: V√° no Microsoft Entra &gt; Identity &gt; Monitoring &amp; health &gt; Sign-in logs; Aplique o filtro por Authentication Protocol: Device Code; Se houver autentica√ß√µes deste tipo, ser√£o apresentadas nos resultados da busca;Exemplo via Log Analytics (KQL):SigninLogs| where TimeGenerated &gt; ago(7d)| where AuthenticationProtocol == \"deviceCode\"| summarize by AppDisplayName, UserIdüîó Refer√™nciasConditional Access: Authentication flowsProtect your users from Device Code Flow abuseMicrosoft-managed Conditional Access policies: Block device code flow‚úÖ Conclus√£oEmbora o Device Code Flow seja √∫til em cen√°rios leg√≠timos, ele tamb√©m representa um vetor de ataque explor√°vel, especialmente contra usu√°rios menos atentos. Ataques como o do STORM-2372 evidenciam a necessidade de rever continuamente as superf√≠cies de autentica√ß√£o permitidas no seu ambiente.A recomenda√ß√£o da Microsoft √© clara: bloqueie esse fluxo a menos que absolutamente necess√°rio e, mesmo nesse caso, aplique exce√ß√µes bem controladas e monitoradas.Proteger sua identidade na nuvem vai al√©m de MFA. Monitoramento cont√≠nuo, bloqueio de fluxos legados e pol√≠ticas de acesso adapt√°veis s√£o essenciais para manter sua organiza√ß√£o segura.√â isso meus amigos, at√© a pr√≥xima! ü§ò" }, { "title": "Primeiros Passos com o Microsoft Graph no PowerShell", "url": "/posts/MicrosoftGraph/", "categories": "PowerShell, Microsoft Graph", "tags": "powershell, microsoft365, graph, exchange, teams, entra id, sharepoint", "date": "2025-05-06 16:00:00 -0300", "snippet": " Ol√°, pessoal!Que tal come√ßarmos falando sobre PowerShell? E nada melhor do que iniciar com um dos m√≥dulos mais utilizados atualmente quando o assunto √© Microsoft Cloud (Azure / M365).O Microsoft ...", "content": " Ol√°, pessoal!Que tal come√ßarmos falando sobre PowerShell? E nada melhor do que iniciar com um dos m√≥dulos mais utilizados atualmente quando o assunto √© Microsoft Cloud (Azure / M365).O Microsoft Graph PowerShell √© um m√≥dulo moderno e poderoso que permite tamb√©m interagir com dados do Microsoft 365 de forma centralizada, segura e escal√°vel. Atrav√©s de cmdlets baseados em REST API, voc√™ pode consultar, gerenciar e automatizar tarefas envolvendo: Microsoft Entra ID Microsoft Teams Exchange Online SharePoint Online OneDrive Business Intune e muito mais.üß∞ Pr√©-requisitosAntes de utilizar o m√≥dulo, certifique-se de ter: PowerShell 5.1 ou superior (Windows) ou PowerShell 7+ (cross-platform) Sistema operacional: Windows 10/11, Windows Server, ou macOS/Linux com PowerShell 7 Permiss√µes adequadas para acessar os recursos do Microsoft 365 Install PowerShell for Windows Install PowerShell for Linux Install PowerShell for macOS üì¶ Instalando o M√≥duloExecute o seguinte comando no PowerShell com permiss√µes de administrador:Install-Module Microsoft.Graph -Scope CurrentUserüí° Se quiser instalar m√≥dulos espec√≠ficos (como Microsoft.Graph.Users), voc√™ pode especific√°-los:Install-Module Microsoft.Graph.Users -Scope CurrentUserüîê Autenticando no Microsoft GraphAntes de tudo: A API do Graph reconhece dois tipos de autentica√ß√£o, delegado e aplicativos.O acesso delegado permite que um aplicativo atue em nome de um usu√°rio autenticado, utilizando as permiss√µes atribu√≠das a esse usu√°rio. J√° o acesso de aplicativo (ou somente para aplicativos) permite que o aplicativo atue de forma aut√¥noma, como uma entidade pr√≥pria ‚Äî ideal para servi√ßos e scripts que n√£o dependem da intera√ß√£o direta de um usu√°rio.Se voc√™ precisa que a chamada de API seja executada com as permiss√µes de um usu√°rio espec√≠fico, utilize acesso delegado. Por outro lado, se est√° executando tarefas automatizadas, como scripts ou servi√ßos em segundo plano, opte pelo acesso de aplicativo.√â importante observar que algumas APIs s√≥ aceitam chamadas com acesso delegado, outras apenas com acesso de aplicativo, e h√° aquelas que funcionam com ambos os m√©todos.Durante o processo de autentica√ß√£o, √© essencial definir corretamente o escopo das permiss√µes solicitadas. Isso garante a aplica√ß√£o do princ√≠pio do menor privil√©gio, evitando a concess√£o de permiss√µes desnecess√°rias. Por exemplo:Connect-MgGraph -Scopes \"User.Read.All\",\"Group.ReadWrite.All\"Por√©m, tamb√©m √© poss√≠vel iniciar uma sess√£o, desta forma:Connect-MgGraphVoc√™ ser√° redirecionado para uma janela de login. Ap√≥s autentica√ß√£o, poder√° come√ßar a executar os cmdlets.Verifique os escopos e permiss√µes com:Get-MgContextüåê Exemplos de Comandos √öteisAbaixo est√£o alguns exemplos pr√°ticos do dia a dia:Listar os usu√°rios do Microsoft Entra IDGet-MgUser | Select-Object DisplayName, UserPrincipalName, AccountEnabledObter detalhes de um usu√°rio espec√≠ficoGet-MgUser -UserId \"usuario@dominio.com\"Listar todos os grupos do Microsoft 365Get-MgGroup | Select DisplayName, MailEnabled, SecurityEnabledObter caixas de correio (Exchange Online)Get-MgUser | Where-Object { $_.Mail -like \"*@dominio.com\" } | Select DisplayName, MailObter os membros de um grupoGet-MgGroupMember -GroupId \"id-do-grupo\"Para obter o ID de um grupo:Get-MgGroup | Format-Table DisplayName, Idüìò Dicas √∫teisVoc√™ pode carregar apenas os m√≥dulos necess√°rios para sua tarefa:Import-Module Microsoft.Graph.UsersCarregar apenas os comandos espec√≠ficos do m√≥dulo que voc√™ vai utilizar √© uma √≥tima pr√°tica ‚Äî sua m√°quina agradece. Importar todo o m√≥dulo do Microsoft Graph pode levar mais tempo, ent√£o essa √© uma boa alternativa quando voc√™ precisa de mais agilidade.Use Disconnect-MgGraph para encerrar a sess√£o com seguran√ßa.Para atualizar o m√≥dulo:Update-Module Microsoft.Graphüìö Documenta√ß√£o oficialMicrosoft Graph PowerShell DocsPermiss√µes e escopos da API‚úÖ Conclus√£o√â isso meus amigos, hoje vamos ficar por aqui. Nos pr√≥ximos posts, veremos de forma mais avan√ßada como esse recurso pode ser extremamente √∫til.O m√≥dulo Microsoft Graph para PowerShell permite agilidade, centraliza√ß√£o e automa√ß√£o no gerenciamento de solu√ß√µes Microsoft 365. Dominar esse recurso transforma sua rotina de administra√ß√£o em algo muito mais eficiente e escal√°vel.Experimente, explore a documenta√ß√£o oficial e integre o Graph ao seu dia a dia e aos seus scripts!At√© a pr√≥xima! ü§ò" } ]
