[ { "title": "Configura√ß√µes do Microsoft Entra PIM com PowerShell", "url": "/posts/AzurePIM-Parte2/", "categories": "Entra ID, Security", "tags": "Entra ID, Microsoft 365, PIM, Azure, Least Privilege, PowerShell, Microsoft Graph", "date": "2025-07-12 19:00:00 -0300", "snippet": " Ol√°, pessoal!Gerenciar acessos privilegiados em ambientes de nuvem √© um dos maiores desafios de seguran√ßa atualmente. Por isso, o Microsoft Entra Privileged Identity Management (PIM) se torna uma...", "content": " Ol√°, pessoal!Gerenciar acessos privilegiados em ambientes de nuvem √© um dos maiores desafios de seguran√ßa atualmente. Por isso, o Microsoft Entra Privileged Identity Management (PIM) se torna uma pe√ßa essencial para qualquer organiza√ß√£o que deseje proteger recursos sens√≠veis sem comprometer a produtividade.Obs: O PIM exige licenciamento: Microsoft Entra ID P2, Microsoft 365 E5, Microsoft 365 E5 Security ou Enterprise Mobility + Security E5Neste segundo post sobre o PIM, vamos ver como configurar alguns recursos via PowerShell. Isso me ajudou muito em um projeto de implanta√ß√£o do PIM, onde uma das etapas era a configura√ß√£o de v√°rios grupos e fun√ß√µes no PIM, e sem os scripts eu levaria muito mais tempo para finalizar.Refrescando a mem√≥ria de todos: O PIM √© uma solu√ß√£o da Microsoft que permite conceder acessos privilegiados de forma just-in-time, ou seja, tempor√°ria, controlada e com requisitos adicionais de seguran√ßa, como autentica√ß√£o multifator (MFA), justificativas e aprova√ß√µes.Ent√£o com o PIM, √© poss√≠vel: Controlar quem pode ativar fun√ß√µes privilegiadas; Exigir justificativas e MFA antes da ativa√ß√£o; Configurar limites de dura√ß√£o da sess√£o (ex: 4h); Gerar alertas e notifica√ß√µes sobre acessos e ativa√ß√µes; Delegar acesso sem adicionar diretamente permiss√µes permanentes;Bom, vamos l√°! H√° algumas estrat√©gias para implementa√ß√µes, uma bastante utilizada, √© a ado√ß√£o de Grupos de Seguran√ßa do Microsoft Entra ID, definindo os grupos por ‚Äòroles‚Äô e/ou ‚Äòsubscriptions‚Äô, por exemplo. Vamos seguir desta forma (com grupos), pois √© uma estrat√©gia amplamente utilizada, e pouco demonstrada/utilizada nos laborat√≥rios de procedimentos e v√≠deos de implementa√ß√£o do PIM.Os grupos podem ser criados via PowerShell e depois associados √†s fun√ß√µes espec√≠ficas dentro do PIM. Voc√™ pode criar um arquivo CSV e incluir o nome de todos os grupos que voc√™ deseja criar. Pode ser uma etapa importante, para j√° criar um padr√£o de nomenclatura dos grupos, nem que seja pelo menos para os grupos do PIM.$csvPath = \"groups.csv\"$groups = Import-Csv -Path $csvPathforeach ($group in $groups) { New-AzureADMSGroup -DisplayName $group.GroupName ` -MailEnabled $false ` -MailNickName $group.GroupName ` -SecurityEnabled $true ` -IsAssignableToRole $true}Write-Output \"Grupos criados e processo concluido.\" Importante definir o par√¢metro ‚ÄúIsAssignableToRole‚Äù como $true para que o grupo possa receber atribui√ß√µes de fun√ß√µes.‚öôÔ∏è Automa√ß√µes via PowerShellObter informa√ß√µes dos gruposSe voc√™ for utilizar Grupos de Seguran√ßa, voc√™ deve primeiro obter o ObjectId dos grupos que voc√™ criou para o PIM.Get-MgPolicyRoleManagementPolicy -Filter \"scopeId eq '&lt;GroupId&gt;' and scopeType eq 'Group'\"Salve estes IDs em um arquivo CSV para seguirmos para a pr√≥xima etapa. Vamos obter agora o ‚ÄúPolicyID Group‚Äù, que √© diferente do GroupID. Aqui, voc√™ ir√° obter o ID das pol√≠ticas do PIM for Groups.$inputFilePath = \"input.csv\"$outputFilePath = \"output.csv\"$scopeIDs = Import-Csv -Path $inputFilePath | Select-Object -ExpandPropertyscopeID$resultados = @()foreach ($scopeID in $scopeIDs) { $policy = Get-MgPolicyRoleManagementPolicy -Filter \"scopeId eq '$scopeID'and scopeType eq 'Group'\" $resultados += $policy}$resultados | Export-Csv -Path $outputFilePath -NoTypeInformation Voc√™ ver√° que os IDs exportados possuem muito mais caracteres do que os ObjectIDs dos grupos. O resultado √© a ‚Äúconcatena√ß√£o‚Äù do ID do Grupo + ID das pol√≠ticas do PIM for Groups.Configura√ß√µes do PIMAs imagens abaixo, v√£o ajudar a entender, onde √© aplicado cada uma das configura√ß√µes realizadas atrav√©s dos scripts, que veremos a seguir. Os scripts para as configura√ß√µes do PIM, utilizam o m√≥dulo do Microsoft Graph para Powershell.Voc√™ pode baixar os scripts no seguinte link: GitHub - PIM Settings PowerShell Number Script Description 1 DurationTime.ps1 Configura√ß√£o do tempo de ativa√ß√£o da fun√ß√£o. 3 ConditionalAccess.ps1 Solicita√ß√£o do MFA atrav√©s de Conditional Access para ativa√ß√£o da fun√ß√£o. 9 Notification_Admin_Admin_Eligibility.ps1 Notifica√ß√µes aos ‚ÄúAdministradores‚Äù quando um usu√°rio for atribu√≠do como ‚ÄúEleg√≠vel‚Äù. 10 Notification_Requestor_Admin_Eligibility.ps1 Notifica√ß√µes aos ‚ÄúSolicitantes‚Äù quando um usu√°rio for atribu√≠do como ‚ÄúEleg√≠vel‚Äù. 11 Notification_Approver_Admin_Eligibility.ps1 Notifica√ß√µes aos ‚ÄúAprovadores‚Äù quando um usu√°rio for atribu√≠do como ‚ÄúEleg√≠vel‚Äù. 12 Notification_Admin_Admin_Assignment.ps1 Notifica√ß√µes aos Administradores quando um usu√°rio for atribu√≠do como ‚ÄúAtivo‚Äù. 13 Notification_Requestor_Admin_Assignment.ps1 Notifica√ß√µes aos ‚ÄúSolicitantes‚Äù quando um usu√°rio for atribu√≠do como ‚ÄúAtivo‚Äù. 14 Notification_Approver_Admin_Assignment.ps1 Notifica√ß√µes aos ‚ÄúAprovadores‚Äù quando um usu√°rio for atribu√≠do como ‚ÄúAtivo‚Äù. 15 Notification_Admin_EndUser_Assignment.ps1 Notifica√ß√µes aos Administradores quando um usu√°rio ‚ÄúEleg√≠vel‚Äù ativar a fun√ß√£o. 16 Notification_Requestor_EndUser_Assignment.ps1 Notifica√ß√µes aos ‚ÄúSolicitantes‚Äù quando um usu√°rio ‚ÄúEleg√≠vel‚Äù ativar a fun√ß√£o. 17 Notification_Approver_EndUser_Assignment.ps1 Notifica√ß√µes aos ‚ÄúAprovadores‚Äù quando um usu√°rio ‚ÄúEleg√≠vel‚Äù ativar a fun√ß√£o. Todos os scripts .ps1 no GitHub iniciam o nome com ‚ÄúPIM-Settings‚Äù (Ex: PIM-Settings_DurationTime.ps1). Por√©m, removi desta tabela, para ter mais espa√ßo e ficar um pouco mais harmonioso, rs.As configura√ß√µes dos par√¢metros dos grupos no PIM, podem ser totalmente automatizadas por scripts. Cada grupo ou fun√ß√£o passa por uma s√©rie de defini√ß√µes: Dura√ß√£o de ativa√ß√£o: 4 horas (exemplo); MFA obrigat√≥rio via pol√≠tica de acesso condicional; Notifica√ß√µes ativadas/desativadas dependendo do tipo de usu√°rio (Admin, Solicitante ou Aprovador); Controle de notifica√ß√µes para atribui√ß√µes e ativa√ß√µes;Al√©m disso, os scripts tamb√©m podem ser utilizados para: Realizar o onboarding dos grupos no PIM; Aplicar pol√≠ticas de expira√ß√£o e autentica√ß√£o; Listar todos os usu√°rios eleg√≠veis a ativar fun√ß√µes dentro do PIM; Exig√™ncia de MFA via Contexto de Autentica√ß√£o (aqui tem um pulo do gato);Solicitar MFA para ativar fun√ß√£o no PIMUma pol√≠tica de acesso condicional deve ser criada com um Authentication Context, caso voc√™ queira exigir o MFA toda vez que um usu√°rio ativar uma fun√ß√£o no PIM. Isso cria uma camada adicional de prote√ß√£o, garantindo que apenas usu√°rios validados e confi√°veis executem a√ß√µes sens√≠veis. E aqui esta o ‚Äúsegredo‚Äù, o Authentication Context. Voc√™ precisa dele se quiser utilizar o MFA cada vez que for ativar uma fun√ß√£o atrav√©s do PIM. N√£o adianta apenas marcar o Azure MFA nas configura√ß√µes da fun√ß√£o ou do grupo, que n√£o ir√° funcionar como o esperado. Com a op√ß√£o Azure MFA, os usu√°rios podem n√£o ser solicitados a efetuar autentica√ß√£o multifator se tiverem se autenticado com credenciais fortes ou fornecido autentica√ß√£o multifator anteriormente na sess√£o.Nas configura√ß√µes (Settings) do grupo, selecione Microsoft Entra Conditional Access authentication context: Authentication ContextTamb√©m ser√° necess√°rio configurarmos um Conditional Access. Mas antes, vamos criar o Authentication Context. V√° at√© Entra ID &gt; Conditional Access &gt; Authentication context; New authentication context &gt; D√™ um nome, uma descri√ß√£o e escolha um ID; Clique em Save;Conditional AccessCrie uma nova pol√≠tica de acesso condicional e fa√ßa o seguinte:. Users: Selecione os grupos/usu√°rios que voc√™ quer aplicar;. Target resources: Select what this policy applies to: Authentication Context; . Authentication Context: Selecione o que voc√™ criou anteriormente;. Grant: Selecione Require authentication strength com a op√ß√£o Multifactor Authentication;. Session: Sign-in frequency - Every time;. Enable policy: On;Podemos ver atrav√©s das configura√ß√µes do grupo em quest√£o, que o Authentication Context esta definido:Agora √© s√≥ testar e‚Ä¶ Voil√†! Sempre que for ativar uma fun√ß√£o ou atribui√ß√£o ao grupo do PIM, ser√° solicitado o MFA.üîç B√¥nus: Listar usu√°rios eleg√≠veis dos Grupos no PIMOs usu√°rios eleg√≠veis aos grupos de seguran√ßa no PIM, podem ser visualizados atrav√©s do Portal da Azure,de forma individual, escolhendo o grupo e visualizando os usu√°rios eleg√≠veis (conforme imagem abaixo), mas como a ideia aqui √© utilizar o Microsoft Graph via Powershell, vamos fazer isso atrav√©s de script!O script abaixo, exporta para um arquivo CSV os usu√°rios eleg√≠ves de todos os grupos do PIM, neste exemplo, grupos que iniciam com o nome ‚ÄúG-PIM‚Äù (como √© bom ter um padr√£o de nomenclatura, hein?!).Connect-MgGraph -Scopes \"Group.Read.All\", \"User.Read.All\"$outputCsvPath = \"C:\\Temp\\EligibleUsers_PIMforGroups_G-PIM.csv\"$results = @()$groups = Get-MgGroup -Filter \"startswith(DisplayName, 'G-PIM')\" -Property Id, DisplayNameforeach ($group in $groups) { $groupId = $group.Id $members = Get-MgBetaIdentityGovernancePrivilegedAccessGroupEligibilitySchedule -Filter \"groupId eq '$groupId'\" foreach ($member in $members) { $user = Get-MgUser -UserId $member.PrincipalId -Property Id, DisplayName, UserPrincipalName, AccountEnabled $result = [PSCustomObject]@{ GroupId = $group.Id GroupName = $group.DisplayName UserId = $user.Id UserDisplayName = $user.DisplayName UserPrincipalName = $user.UserPrincipalName AccountEnabled = $user.AccountEnabled } $results += $result }}$results | Export-Csv -Path $outputCsvPath -NoTypeInformation -Encoding UTF8Write-Output \"Os dados foram exportados para $outputCsvPath\" √â uma boa forma de criar um report de quais usu√°rios s√£o eleg√≠veis aos grupos do PIM.üìö Documenta√ß√£o oficialüìñ Microsoft Entra PIMüìñ Rules in PIM - Mapping guideüìñ Configure authentication contexts‚úÖ Conclus√£oO PIM √© uma ferramenta poderosa para reduzir riscos, refor√ßar controles e garantir que o princ√≠pio do menor privil√©gio seja uma realidade no seu ambiente Microsoft.Se voc√™ ainda n√£o est√° usando o PIM no seu ambiente, este √© um excelente momento para come√ßar a planejar! Ainda mais agora, que voc√™ possui dicas valiosas (e scripts) de como executar algumas a√ß√µes.Bom, fechamos aqui. At√© a pr√≥xima! ü§ò" }, { "title": "Mapeamento de Rule IDs no Microsoft Entra PIM", "url": "/posts/AzurePIM/", "categories": "Entra ID, Security", "tags": "Entra ID, Microsoft 365, PIM, Azure, Least Privilege", "date": "2025-06-19 08:00:00 -0300", "snippet": " Ol√°, pessoal!Se voc√™ j√° precisou gerenciar acessos privilegiados dentro do Microsoft Azure, provavelmente j√° ouviu falar do Microsoft Entra Privileged Identity Management (PIM). A ideia aqui n√£o ...", "content": " Ol√°, pessoal!Se voc√™ j√° precisou gerenciar acessos privilegiados dentro do Microsoft Azure, provavelmente j√° ouviu falar do Microsoft Entra Privileged Identity Management (PIM). A ideia aqui n√£o √© falar do PIM como um todo, mas de uma das caracter√≠sticas dele, at√© porque j√° √© uma solu√ß√£o bastante conhecida e existem muitos posts e v√≠deos na internet sobre ele. Mas se ainda n√£o conhece, deixa eu te explicar muito rapidamente o que √©:O Microsoft Entra PIM √© uma solu√ß√£o da Microsoft que ajuda a controlar, proteger e monitorar o acesso a recursos importantes na nuvem. Ele √© como um porteiro super inteligente que s√≥ libera a entrada de quem realmente precisa, quando precisa, e pelo tempo necess√°rio.Com o PIM, voc√™ consegue coisas como: Concess√£o de acesso just-in-time; Aprova√ß√£o de acesso por fluxo de aprova√ß√£o; Auditoria de quem teve acesso e quando; Revis√µes peri√≥dicas de acesso;Mapeamento de Rule IDs para configura√ß√µes de fun√ß√µes no PIMBom, agora vamos para o assunto deste post. Se voc√™ j√° come√ßou a explorar as Assignment Rules no Microsoft Entra Privileged Identity Management, provavelmente se deparou com um detalhe t√©cnico que pode causar algumas d√∫vidas: o tal do ‚ÄúMapping of rule IDs to PIM role settings‚Äù.Calma! O conceito √© mais simples do que parece. Fa√ßamos como o Jack, vamos por partes‚Ä¶Por que existe esse mapeamento?Toda vez que voc√™ configura uma regra de atribui√ß√£o (Assignment Rule) dentro do Microsoft Entra Admin Center, o sistema est√° por tr√°s associando essa configura√ß√£o a um Rule ID espec√≠fico.Isso √© importante principalmente quando voc√™ est√° interagindo com o Microsoft Graph API, fazendo automa√ß√µes ou exportando configura√ß√µes. No portal, voc√™ v√™ tudo com nomes amig√°veis e bot√µes ‚Äúbonitinhos‚Äù‚Ä¶ mas via API, √© tudo por meio de IDs num√©ricos ou strings de identifica√ß√£o √∫nicas.Como funciona o mapeamento?Basicamente, cada configura√ß√£o que voc√™ faz no PIM (exemplo: exigir aprova√ß√£o, exigir MFA, etc) corresponde a um Rule ID no backend da Microsoft.A tabela de mapeamento serve para ajudar voc√™ a entender qual Rule ID corresponde a qual configura√ß√£o vis√≠vel no portal.Por exemplo: Rule ID O que significa no Portal EligibilityRule Determina quem pode ser eleg√≠vel para determinada fun√ß√£o ActivationRule Regras de ativa√ß√£o: se exige aprova√ß√£o, MFA, motivo, etc AssignmentRule Regras baseadas em atributos de usu√°rios para autoatribui√ß√£o (Esses nomes s√£o exemplos ilustrativos. Veja a tabela oficial na documenta√ß√£o para os IDs reais.)üìñ Mapping of rule IDs to PIM role settings on the Microsoft Entra admin centerOnde isso impacta na pr√°tica?Se voc√™ est√° s√≥ configurando pelo portal Entra Admin Center, provavelmente nunca vai precisar olhar para esses IDs.Mas se voc√™: Trabalha com PowerShell Faz integra√ß√£o via Microsoft Graph API Gera relat√≥rios personalizados Ou faz auditorias detalhadas‚Ä¶ ent√£o saber o mapeamento entre os Rule IDs e os nomes das configura√ß√µes vai te ajudar bastante.Exemplo pr√°tico com Graph APIDigamos que voc√™ consulte uma role com a API e veja algo como:{ \"id\": \"activationRule\", \"ruleSettings\": { \"multiFactorAuthRequired\": true, \"justificationRequired\": true }}ou$unifiedRoleManagementPolicyRuleId = \"Expiration_EndUser_Assignment\"$params01 = @{ \"@odata.type\" = \"#microsoft.graph.unifiedRoleManagementPolicyExpirationRule\" id = \"Expiration_EndUser_Assignment\" isExpirationRequired = $true maximumDuration = \"PT4H\" target = @{ \"@odata.type\" = \"microsoft.graph.unifiedRoleManagementPolicyRuleTarget\" caller = \"EndUser\" operations = @( \"All\" ) level = \"Assignment\" inheritableSettings = @() enforcedSettings = @() } } O que significa isso? Voc√™ j√° vai entender. Mas vamos compreender melhor, no pr√≥ximo post.Por exemplo, a imagem a seguir mostra as configura√ß√µes de fun√ß√£o de ativa√ß√£o no centro de administra√ß√£o do Microsoft Entra, mapeadas para regras e tipos de recursos nas APIs do PIM no Microsoft Graph. Number Microsoft Entra admin center UX Description Microsoft Graph rule ID / Derived resource type 1 Activation maximum duration (hours) Expiration_EndUser_Assignment / unifiedRoleManagementPolicyExpirationRule 2 On activation, require: None, Azure MFA Require ticket information on activation Require justification on activation Enablement_EndUser_Assignment / unifiedRoleManagementPolicyEnablementRule 3 On activation, require: Microsoft Entra Conditional Access authentication context (Preview) AuthenticationContext_EndUser_Assignment / unifiedRoleManagementPolicyAuthenticationContextRule 4 Require approval to activate Approval_EndUser_Assignment / unifiedRoleManagementPolicyApprovalRule Talvez agora, j√° tenha ficado um pouco mais f√°cil entender os scripts mostrados acima.Com estas informa√ß√µes mapeadas, voc√™ poder√° utilz√°-las em script Powershell com o m√≥dulo do Microsoft Graph para definir as configura√ß√µes desejadas em v√°rios usu√°rios/grupos do PIM de uma √∫nica vez.Foi exatamente isso que precisei em um cliente, onde realizar a configura√ß√£o manualmente para cada um dos grupos, levaria muito tempo. E assim, consegui econimizar um bom tempo e trabalho manual.Ent√£o, no pr√≥ximo post, vou trazer todos os scripts que utilizei para que voc√™s possam conhecer e se necess√°rio possam utiliz√°-los tamb√©m em seus projetos ou laborat√≥rios.‚úÖ Conclus√£oSe a sua opera√ß√£o com o Azure PIM for mais ‚Äúclicar e configurar‚Äù, talvez voc√™ nunca precise se preocupar com esses detalhes de mapeamento de Rule IDs.Mas se voc√™ pretende automatizar, auditar ou gerar relat√≥rios t√©cnicos, entender o mapeamento entre Rule IDs e as configura√ß√µes do PIM pode te poupar muitas dores de cabe√ßa.Para esta primeira parte, √© isso. At√© a pr√≥xima! ü§ò" }, { "title": "Definir Wallpaper via Intune com Atualiza√ß√£o Din√¢mica", "url": "/posts/WallpaperIntune/", "categories": "Intune", "tags": "Microsoft365, Wallpaper, Configuration, Intune, Endpoint", "date": "2025-05-30 16:00:00 -0300", "snippet": " Ol√°, pessoal!Voc√™s sabem que aplicar um papel de parede nos computadores da companhia, √© uma tarefa muito normal em praticamente todas as empresas, n√£o √© verdade?! E executar esta \"modesta\" ativi...", "content": " Ol√°, pessoal!Voc√™s sabem que aplicar um papel de parede nos computadores da companhia, √© uma tarefa muito normal em praticamente todas as empresas, n√£o √© verdade?! E executar esta \"modesta\" atividade via Microsoft Intune parece simples √† primeira vista, no entanto, quem j√° tentou fazer isso em m√°quinas com Windows 10/11 Pro sabe que a abordagem padr√£o, usando perfis de restri√ß√£o de dispositivo, esbarra em algumas limita√ß√µes.Este post, inspirado no excelente artigo do MVP 'Gannon Novak' do site SMBtotheCloud vai lhe mostrar atrav√©s de uma √≥timo solu√ß√£o alternativa, como usar scripts PowerShell e a implanta√ß√£o de aplicativos Win32 no Microsoft Intune para aplicar este tipo de configura√ß√£o.Vamos n√£o apenas configurar o Wallpaper, mas tamb√©m implementar um m√©todo inteligente para atualiz√°-lo dinamicamente, sem a necessidade de reempacotar e redistribuir o aplicativo ou ajustar o script a cada mudan√ßa. üé∞ O Desafio: Por que o m√©todo padr√£o falha no Windows 10 Pro?A forma mais direta de configurar o papel de parede no Intune √© atrav√©s de um Perfil de Configura√ß√£o de Dispositivo &gt; Restri√ß√µes de Dispositivo. L√°, voc√™ encontra op√ß√µes para especificar URLs para as imagens desejadas. Simples, certo?O problema √© que essas configura√ß√µes espec√≠ficas s√£o aplic√°veis apenas √†s edi√ß√µes Enterprise e Education do Windows 10/11. Se voc√™ tentar aplicar esse perfil a um dispositivo com Windows 10/11 Pro, o status da pol√≠tica no Intune mostrar√° \"N√£o aplic√°vel\". Precisamos ent√£o, de um caminho alternativo. Bora!üéØ A Solu√ß√£o: Scripts PowerShell e o Registro do WindowsQuando as pol√≠ticas padr√£o n√£o funcionam, muitas vezes a solu√ß√£o est√° em manipular diretamente o Registro do Windows. √â exatamente isso que faremos. Vamos usar scripts PowerShell para: Criar as chaves e valores necess√°rios no registro para definir a imagem; Baixar a imagem desejada de um local acess√≠vel (como o Azure Blob Storage); Configurar o sistema para usar a imagem baixada;Para distribuir e executar esses scripts de forma gerenciada atrav√©s do Intune, utilizaremos o recurso de implanta√ß√£o de Aplicativos Win32.O Script de Instala√ß√£o (Configura√ß√£o Inicial)O primeiro passo √© criar um script PowerShell que far√° a configura√ß√£o inicial. Este script ser√° empacotado como um aplicativo Win32, como j√° informado. Abaixo o c√≥digo, com as explica√ß√µes:# Garante que o caminho base no registro exista, sen√£o ser√° criadoNew-Item HKLM:\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\PersonalizationCSP -Force# Caminho base no registro onde as configura√ß√µes ser√£o aplicadas$RegPath = \"HKLM:\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\PersonalizationCSP\"# URL da imagem (substitua pelo seu link - Ex: Azure Blob Storage)$BackgroundImageURL = 'https://seu_storage.blob.core.windows.net/wallpaper/background.jpg'# Pasta local onde a imagem ser√° salva no cliente$ImageDestinationFolder = \"C:\\MDM\\images\"# Caminho completo para o arquivo da imagem local$Backgroundimage = \"$ImageDestinationFolder\\background.jpg\"# Cria a pasta C:\\MDM\\images se ela n√£o existir. O -ErrorAction SilentlyContinue evita erros caso a pasta j√° exista.md $ImageDestinationFolder -ErrorAction SilentlyContinue# Usa o BITS (Background Intelligent Transfer Service) para baixar a imagem da URL especificadaStart-BitsTransfer -Source $BackgroundImageURL -Destination \"$Backgroundimage\"# Configura√ß√£o das Chaves do Registro para o Papel de ParedeNew-ItemProperty -Path $RegPath -Name DesktopImagePath -Value $backgroundimage -PropertyType String -Force | Out-NullNew-ItemProperty -Path $RegPath -Name DesktopImageUrl -Value $backgroundimage -PropertyType String -Force | Out-NullNew-ItemProperty -Path $RegPath -Name DesktopImageStatus -Value 1 -PropertyType DWORD -Force | Out-Nullexit 0Pontos importantes sobre este script: URL da Imagem: Voc√™ precisa substituir a URL de exemplo ($BackgroundImageURL) pela URL real onde sua imagem est√° hospedada. O Azure Blob Storage √© uma √≥tima op√ß√£o, garantindo que a imagem esteja acess√≠vel publicamente (ou via SAS token, se necess√°rio, mas o script assume acesso an√¥nimo aqui). Nome do Arquivo: O script assume que a imagem se chamar√° 'background.jpg'. Manter esse nome √© crucial para o funcionamento do script de detec√ß√£o que veremos a seguir. Se mudar o nome do arquivo, n√£o esque√ßa de mudar no script. Pasta de Destino: A imagem √© salva em ‚ÄòC:\\MDM\\Images‚Äô. Certifique-se de que n√£o haja pol√≠ticas bloqueando a cria√ß√£o ou escrita nesta pasta, ou ajuste o caminho ($ImageDestinationFolder) conforme necess√°rio.Abaixo, o script de Uninstall, que nada mais √© que, a remo√ß√£o das chaves de registro:Remove-ItemProperty -Path \"HKLM:\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\PersonalizationCSP\" -Name \"DesktopImagePath\"Remove-ItemProperty -Path \"HKLM:\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\PersonalizationCSP\" -Name \"DesktopImageUrl\"Remove-ItemProperty -Path \"HKLM:\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\PersonalizationCSP\" -Name \"DesktopImageStatus\"exit 0üé∞ O Desafio da Atualiza√ß√£o e o Script de Detec√ß√£o InteligenteOk, a configura√ß√£o inicial est√° resolvida. Mas e se a empresa quiser trocar as imagens de vez em quando, ou para campanhas espec√≠ficas? Com a abordagem Win32 App padr√£o, ter√≠amos que: Atualizar a imagem no Blob Storage; (Potencialmente) Alterar o script de instala√ß√£o se algo mudasse; Reempacotar o script usando a Ferramenta de Prepara√ß√£o de Conte√∫do Win32 da Microsoft (IntuneWinAppUtil.exe); Fazer upload da nova vers√£o do arquivo .intunewin para o Intune; Aguardar a distribui√ß√£o e instala√ß√£o nos clientes;Isso √© trabalhoso e propenso a erros. A beleza da solu√ß√£o proposta pelo 'Gannon Novak' est√° no script de detec√ß√£o personalizado.O Intune, ao implantar um aplicativo Win32, usa regras de detec√ß√£o para verificar se o aplicativo j√° est√° instalado corretamente. Normalmente, isso envolve verificar a exist√™ncia de um arquivo, pasta ou chave de registro espec√≠fica. No nosso caso, usaremos um script PowerShell personalizado como regra de detec√ß√£o.Este script de detec√ß√£o far√° o seguinte: Baixar√° a vers√£o atual da imagem (background.jpg) do Blob Storage para uma pasta tempor√°ria; Comparar√° a data/hora da √∫ltima modifica√ß√£o (timestamp) dessa imagem rec√©m-baixada com a imagem que j√° est√° na pasta C:\\MDM\\images do cliente; Verificar√° tamb√©m se as chaves de registro relevantes est√£o configuradas corretamente; Se o timestamp da imagem local e remota coincidirem e as chaves de registro estiverem corretas, o script retornar√° ‚ÄúDetected‚Äù (indicando que a vers√£o correta j√° est√° instalada). Se os timestamp diferirem (significando que a imagem no Blob Storage foi atualizada) ou se as chaves de registro estiverem incorretas, o script sair√° com um c√≥digo de erro (exit 1), sinalizando ao Intune que a \"aplica√ß√£o\" (nossa imagem e configura√ß√µes) n√£o est√° no estado desejado. Isso far√° com que o Intune execute novamente o script de instala√ß√£o (Parte 1), que baixar√° a nova imagem e reconfigurar√° o registro.Isso permite que voc√™ simplesmente substitua o arquivo background.jpg no seu Blob Storage. Na pr√≥xima vez que o Intune avaliar a pol√≠tica de detec√ß√£o nos clientes (o que ocorre periodicamente), ele perceber√° a mudan√ßa nos timestamps e automaticamente executar√° o script de instala√ß√£o para atualizar a imagem nos endpoints, sem nenhuma interven√ß√£o manual no Intune! Script de detec√ß√£o: # URL da imagem (DEVE ser a mesma do script de instala√ß√£o)$BackgroundImageURL = 'https://seu_storage.blob.core.windows.net/wallpaper/background.jpg'# Pasta tempor√°ria para baixar a imagem para verifica√ß√£o$TempImageDestinationFolder = \"C:\\MDM\\images\\temp\"# Caminho completo para o arquivo tempor√°rio$TempBackgroundimage = \"$TempImageDestinationFolder\\background.jpg\"# Caminho da imagem atualmente em uso no cliente$CurrentBackgroundImage = \"C:\\MDM\\images\\background.jpg\"# --- Cria√ß√£o do Diret√≥rio Tempor√°rio ---md $TempImageDestinationFolder -ErrorAction SilentlyContinue# Baixa a imagem mais recentes do Blob para a pasta tempor√°riaStart-BitsTransfer -Source $BackgroundImageURL -Destination \"$TempBackgroundimage\"# Pega o timestamp da imagem de fundo baixada do Blob$BlobBackgroundTimestamp = Get-ItemProperty \"$TempBackgroundimage\" | Select-Object -ExpandProperty LastWriteTime# Pega o timestamp da imagem de fundo atualmente no cliente (se existir)$CurrentBackgroundTimestamp = Get-ItemProperty \"$CurrentBackgroundImage\" -ErrorAction SilentlyContinue | Select-Object -ExpandProperty LastWriteTime# Verifica se os valores de registro esperados existem e est√£o corretos$RegDesktopPath = Get-ItemPropertyValue \"HKLM:\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\PersonalizationCSP\" -Name \"DesktopImagePath\" -ErrorAction SilentlyContinue$RegDesktopStatus = Get-ItemPropertyValue \"HKLM:\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\PersonalizationCSP\" -Name \"DesktopImageStatus\" -ErrorAction SilentlyContinue$RegDesktopUrl = Get-ItemPropertyValue \"HKLM:\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\PersonalizationCSP\" -Name \"DesktopImageUrl\" -ErrorAction SilentlyContinue# Remove a pasta tempor√°ria e seu conte√∫do ap√≥s a verifica√ß√£oRemove-Item -Path $TempImageDestinationFolder -Recurse -Force -ErrorAction SilentlyContinue# Compara os timestamps e os valores do registroIf (($CurrentBackgroundTimestamp -eq $BlobBackgroundTimestamp) -and ($RegDesktopStatus -eq 1) -and ($RegDesktopPath -eq $CurrentBackgroundImage) -and ($RegDesktopUrl -eq $CurrentBackgroundImage)){ # Se tudo estiver correto e atualizado, escreve \"Detected\" para o Intune Write-Host \"Detected\" exit 0}Else { # Se algo estiver desatualizado ou incorreto, informa e sai com erro (for√ßa a reinstala√ß√£o) Write-Host \"Imagem desatualizada ou valores de registro ausentes/incorretos.\" exit 1}üì¶ Empacotando e Implantando via IntuneAgora que temos os dois scripts (instala√ß√£o e detec√ß√£o), precisamos empacotar o script de instala√ß√£o como um aplicativo Win32 e configur√°-lo no Intune. Salve os Scripts: Salve o script de instala√ß√£o como install.ps1 e o script de detec√ß√£o como detect.ps1; Baixe a Ferramenta de Prepara√ß√£o: Obtenha a Ferramenta de Prepara√ß√£o de Conte√∫do do Microsoft Win32 (IntuneWinAppUtil.exe) no GitHub oficial da Microsoft: Microsoft Win32 Content Prep Tool Empacote o Script de Instala√ß√£o: Crie uma pasta de origem (ex: C:\\Fonte_wallpaper) e coloque o install.ps1 dentro dela; Crie uma pasta de sa√≠da (ex: C:\\Build_wallpaper); Abra o Prompt de Comando ou PowerShell, navegue at√© onde voc√™ salvou o IntuneWinAppUtil.exe e execute: IntuneWinAppUtil.exe -c C:\\Fonte_wallpaper -s install.ps1 -o C:\\Build_wallpaper Ser√° criado o arquivo install.intunewin no diret√≥rio de sa√≠da. √â ele que voc√™ far√° *upload para o Intune.* Obs: Criei a origem e a sa√≠da no mesmo diret√≥rio, mas recomendo que fa√ßam em diret√≥rios separados, para mitigar poss√≠veis erros.Agora, vamos criar o Aplicativo no Intune: V√° para o portal do Microsoft Intune; Navegue at√© Apps &gt; Windows &gt; + Create; App Type: Windows App (Win32); App information: Selecione o arquivo install.intunewin que voc√™ criou; Preencha os detalhes (Name, Description, Publisher, Category, etc); Install command: %SystemRoot%\\system32\\WindowsPowerShell\\v1.0\\powershell.exe -ExecutionPolicy Bypass -File .\\install.ps1 Uninstall command (Opcional): %SystemRoot%\\system32\\WindowsPowerShell\\v1.0\\powershell.exe -ExecutionPolicy Bypass -File .\\uninstall.ps1 Voc√™ precisaria criar este uninstall.ps1 e empacot√°-lo junto se quiser essa funcionalidade; √â recomendado ter um script que remova as chaves de registro, se necess√°rio; Install behavior: System (para garantir permiss√µes adequadas para escrever em HKLM e C:\\MDM); Requirements: Especifique a arquitetura do SO (32/64 bits) e a vers√£o m√≠nima do Windows; Detection rules: Rules format: Use a custom detection script; Script file: Fa√ßa upload do seu arquivo detect.ps1; Run script as 32-bit process on 64-bit clients: N√£o (geralmente); Enforce script signature check and run script silently: N√£o (a menos que seus scripts estejam assinados); Dependencies: (Geralmente n√£o necess√°rio para este caso); Supersedence: (Geralmente n√£o necess√°rio para este caso); Assignments: Atribua o aplicativo aos grupos de dispositivos desejados (ex: Todos os dispositivos Windows); Review + create: Revise todas as configura√ß√µes e crie o aplicativo;‚úÖ Conclus√£oEmbora a configura√ß√£o inicial de papel de parede no Windows 10/11 Pro via Intune exija uma solu√ß√£o alternativa usando scripts e aplicativos Win32, a abordagem detalhada aqui oferece uma flexibilidade significativa.Ao combinar um script de instala√ß√£o com um script de detec√ß√£o inteligente baseado em *timestamp* de arquivo, voc√™ pode n√£o apenas definir as imagens corporativas, mas tamb√©m atualiz√°-las dinamicamente simplesmente alterando os arquivos de origem em seu reposit√≥rio (como o Blob Storage), sem precisar tocar na configura√ß√£o do Intune novamente.Esta t√©cnica demonstra o poder da automa√ß√£o com PowerShell e a flexibilidade da implanta√ß√£o de aplicativos Win32 no Intune para superar limita√ß√µes e gerenciar configura√ß√µes complexas de forma eficiente.Espero que este tutorial ajude voc√™ a manter um ambiente de trabalho padronizado e atualizado para seus usu√°rios do Windows 10/11 Pro!Bom, √© isso hoje. At√© a pr√≥xima! ü§ò" }, { "title": "Como habilitar o Enhanced Phishing Protection", "url": "/posts/PhishingProtection/", "categories": "Intune, Security", "tags": "Microsoft365, Phishing, Enhanced Phishing Protection, Security, Intune, Endpoint", "date": "2025-05-23 16:00:00 -0300", "snippet": " Ol√°, pessoal!N√£o √© novidade para ningu√©m que a amea√ßa de phishing continua sendo uma das formas mais eficazes de ataque cibern√©tico, especialmente contra usu√°rios \"desatentos\". Da uma olhada nest...", "content": " Ol√°, pessoal!N√£o √© novidade para ningu√©m que a amea√ßa de phishing continua sendo uma das formas mais eficazes de ataque cibern√©tico, especialmente contra usu√°rios \"desatentos\". Da uma olhada neste artigo: Phishing Trends Report (Updated for 2025)Pensando nisso, trouxe aqui, um recurso valioso de seguran√ßa chamado Enhanced Phishing Protection (Prote√ß√£o Avan√ßada contra Phishing), que faz parte do Windows Security e se integra com o Microsoft Defender SmartScreen.Esta semana mesmo peguei um Spear Phishing direcionado a um C-Level da companhia (Whaling). Os ataques n√£o param, tem que estar sempre atento.Este recurso ajuda a proteger os usu√°rios contra ataques de phishing ao detectar tentativas de captura de credenciais e avisa sobre pr√°ticas inseguras, como inserir senhas corporativas em sites ou aplicativos n√£o confi√°veis.O que √© a Enhanced Phishing Protection?A Enhanced Phishing Protection analisa o comportamento do usu√°rio em tempo real e alerta quando: Uma senha do trabalho ou da escola √© digitada em um site malicioso ou inseguro; O usu√°rio tenta reutilizar a senha da conta corporativa em sites pessoais; A senha √© armazenada em arquivos de texto, como .txt ou .docx; Essas prote√ß√µes s√£o ativadas automaticamente no Windows 11, desde que os pr√©-requisitos sejam atendidos.Pr√©-requisitosPara utilizar esse recurso, √© necess√°rio: Windows 11 22H2 ou superior; Dispositivo com Microsoft Defender ativado; Login usando Windows Hello ou uma senha (contas locais e do Microsoft Entra ID s√£o suportadas); üí° Recomendado: Ative o login com Windows Hello for Business sempre que poss√≠vel.Como Habilitar a Prote√ß√£o Avan√ßada contra PhishingVoc√™ pode ativar esse recurso manualmente ou via pol√≠tica, especialmente em ambientes corporativos. Abaixo, mostro os tr√™s principais caminhos:1. Via Configura√ß√µes do Windows Acesse Settings &gt; Privacy and Security &gt; Windows Security Clique em App &amp; browser control Acesse as Reputation-based protection settings Ative as op√ß√µes: ‚ÄúWarn me about malicious apps and sites‚Äù ‚ÄúWarn me about password reuse‚Äù ‚ÄúWarn me about unsafe password storage‚Äù 2. Via Pol√≠tica de Grupo (GPO) Baixe os Modelos Administrativos do Windows Importe o template WindowsDefender.admx Navegue at√©: Computer Configuration &gt; Administrative Templates &gt; System &gt; Windows Defender SmartScreen &gt; Enhanced Phishing Protection Configure as op√ß√µes de prote√ß√£o conforme as pol√≠ticas da sua empresa.3. Via Microsoft IntuneSe voc√™ tem o Microsoft Intune, pode aplicar tamb√©m para todos os dispositivos com Windows 11.Etapas para configurar via Intune: Acesse o Portal do Microsoft Intune V√° at√© Devices &gt; Configuration &gt; Policies Clique em + Create: New Policy Escolha a plataforma: Windows 10 and later Escolha o perfil: Settings catalog Clique em Create D√™ um nome e uma descri√ß√£o para a pol√≠tica e clique em NextNa aba Configuration settings:Clique em + Add settings e localize a configura√ß√£o chamada: Smart Screen\\Enhanced Phishing Protection Configura√ß√£o Valor Notify Malicious Enable Notify Password Reuse Enable Notify Unsafe App Enable Service Enabled Enable üîê Observa√ß√£o: Algumas vers√µes podem exibir os nomes das configura√ß√µes como GUIDs, ent√£o sempre leia a descri√ß√£o da pol√≠tica para confirmar que se trata da Enhanced Phishing Protection.üìö Documenta√ß√£o oficial Enhanced Phishing Protection in Microsoft Defender SmartScreen Protect passwords with enhanced phishing protection‚úÖ Conclus√£oA Enhanced Phishing Protection √© um refor√ßo de seguran√ßa importante no ecossistema do Windows 11, e sua ativa√ß√£o pode prevenir diversos ataques que exploram as famosas falhas humanas.Em um mundo onde o phishing evolui constantemente, investir em recursos proativos como esse pode fazer toda a diferen√ßa para proteger dados corporativos e pessoais.üõ°Ô∏è Dica Extra: Combine essa prote√ß√£o com pol√≠ticas de senha fortes e autentica√ß√£o multifator (MFA) para criar uma camada adicional de seguran√ßa.Se voc√™ ainda n√£o habilitou esse recurso, agora √© a hora. Seguran√ßa come√ßa com pequenas a√ß√µes, e essa √© uma delas.At√© a pr√≥xima! ü§ò" }, { "title": "Como se proteger contra abusos de Device Code Flow", "url": "/posts/AuthenticationFlow/", "categories": "Security, Microsoft Entra ID", "tags": "Microsoft Entra ID, Azure AD, Device Code Flow, Seguran√ßa na Nuvem, Conditional Access", "date": "2025-05-17 22:00:00 -0300", "snippet": " Ol√°, pessoal!Viram que a Microsoft criou uma nova Pol√≠tica de Acesso Condicional em seus Tenants?A pol√≠tica foi criada para bloquear Device Code Flow, que neste post voc√™s v√£o entender melhor do ...", "content": " Ol√°, pessoal!Viram que a Microsoft criou uma nova Pol√≠tica de Acesso Condicional em seus Tenants?A pol√≠tica foi criada para bloquear Device Code Flow, que neste post voc√™s v√£o entender melhor do que se trata. Mas fique tranquilo, a pol√≠tica foi criada como Report-only, por√©m, ap√≥s 45 dias da cria√ß√£o da pol√≠tica em seu tenant, ela ser√° alterada para On.Fique atento, analise os logs relecionadas a esta pol√≠tica para decidir como voc√™ ir√° mant√™-la em seu ambiente.A seguran√ßa de identidades na nuvem tornou-se um pilar essencial para qualquer organiza√ß√£o moderna. Um dos vetores de ataque recentemente explorado por atores maliciosos √© o Device Code Flow, uma alternativa de autentica√ß√£o amplamente utilizada por dispositivos sem navegador, como CLI e aplicativos IoT.Um exemplo recente e not√≥rio √© a campanha conduzida pelo grupo STORM-2372, que abusou do Device Code Flow para comprometer contas corporativas, mesmo com autentica√ß√£o multifator (MFA) habilitada.üß© O que √© o Device Code Flow?O Device Code Flow √© um fluxo de autentica√ß√£o suportado pelo protocolo OAuth 2.0, projetado para dispositivos sem interface gr√°fica/interativa ou sem navegador (ex: Terminal, Smart TVs, CLI).Neste fluxo, o usu√°rio √© instru√≠do a visitar um endere√ßo (ex: https://microsoft.com/devicelogin) em um navegador e inserir um c√≥digo fornecido pelo dispositivo. Isso permite a autentica√ß√£o em segundo plano, sem que o dispositivo em si manipule diretamente as credenciais.Acredito que muitos aqui, j√° utilizaram para autenticar no Microsoft Azure, Netflix, Apple TV+ e assim por diante.Exemplo de uso:az login --use-device-codeEsse comando exibe um c√≥digo e solicita que o usu√°rio v√° at√© um navegador para concluir a autentica√ß√£o. Ap√≥s a conclus√£o, o terminal (ou aplicativo) recebe o token de acesso e pode operar com os privil√©gios do usu√°rio autenticado.‚ö†Ô∏è Como o STORM-2372 Explorou o Device Code FlowO grupo de amea√ßa STORM-2372 (tamb√©m conhecido como Midnight Blizzard, Nobelium, ou APT29) tem abusado do fluxo de c√≥digo do dispositivo como parte de sua cadeia de ataque para evitar bloqueios comuns impostos por MFA e outros mecanismos de prote√ß√£o.A t√©cnica funciona da seguinte forma: O ator malicioso inicia o Device Code Flow de forma programada, por exemplo usando az login --use-device-code ou outras APIs; Exibe um c√≥digo √∫nico de autentica√ß√£o; O atacante envia esse c√≥digo para a v√≠tima, muitas vezes com engenharia social sofisticada, induzindo-a concluir o login (acreditando que se trata de um processo leg√≠timo); Ao concluir a autentica√ß√£o com o c√≥digo, o atacante recebe um token v√°lido, ‚Äúbypassando MFA‚Äù, pois a v√≠tima j√° fez a autentica√ß√£o com sucesso;Por que esse ataque √© eficaz? MFA n√£o √© suficiente: Se a v√≠tima insere o c√≥digo e autentica com MFA, o token ainda vai para o atacante; Dif√≠cil de detectar: O fluxo parece leg√≠timo, e pode usar aplica√ß√µes registradas que n√£o levantam suspeitas; Token de longa dura√ß√£o: Em alguns casos, o token tem validade prolongada, permitindo persist√™ncia no ambiente;üõ°Ô∏è Como se Proteger: Bloqueando o Device Code FlowA Microsoft permite que administradores bloqueiem ou restrinjam o uso do Device Code Flow por meio de pol√≠ticas de acesso condicional gerenciadas no Entra ID (Azure AD).üìå O que s√£o Pol√≠ticas Gerenciadas?Pol√≠ticas gerenciadas s√£o um novo recurso que permite aplicar configura√ß√µes de seguran√ßa automatizadas e baseadas em recomenda√ß√µes da Microsoft, como o bloqueio do Device Code Flow, prote√ß√£o contra autentica√ß√£o herdada (legacy), entre outras. S√£o pol√≠ticas predefinidas que permitem aos administradores simplificar a gest√£o da seguran√ßa, oferecendo op√ß√µes de configura√ß√£o e modifica√ß√µes b√°sicas. Estas pol√≠ticas visam garantir um n√≠vel b√°sico de seguran√ßa para todos os tenants, mesmo aqueles que n√£o t√™m licenciamento Microsoft Entra ID P1 ou P2.N√£o conhecia? Da uma olhada: Microsoft-managed Conditional Access policiesVeja que a Microsoft criou esta pol√≠tica como Report-only no seu tenant, para que voc√™ possa analisar os logs e ter este tipo de prote√ß√£o para sua organiza√ß√£o. √â importante voc√™ monitorar se este tipo de autentica√ß√£o √© utilizado em seu ambiente. Caso n√£o, habilite a politica. Caso sim, tamb√©m habilite a pol√≠tica (rs), e trate a aplica√ß√£o/recurso que precisa utilizar este tipo de autentica√ß√£o, como exce√ß√£o.‚úÖ Etapas para Bloquear o Device Code Flow:Voc√™ tamb√©m pode criar a Conditional Access Policy manualmente: Acesse o portal do Microsoft Entra: https://entra.microsoft.com V√° para Protection &gt; Conditional Access &gt; Policies; Crie uma nova pol√≠tica, defina os usu√°rios, em Target selecione todos os recursos (All cloud apps); Em Conditions selecione Authentication flows; Marque a op√ß√£o Device code flow e Save; Habilite a pol√≠tica (On);Essa pol√≠tica bloquear√° tentativas de autentica√ß√£o usando esse fluxo, exceto para aplicativos e usu√°rios explicitamente permitidos.Mais informa√ß√µes em: Block authentication flows with Conditional Access policyüìå Considera√ß√µes importantes: O bloqueio √© recomendado para organiza√ß√µes que n√£o utilizam dispositivos ou aplicativos que dependem do Device Code Flow. Caso existam aplica√ß√µes leg√≠timas que dependem deste fluxo (ex: Azure CLI, Power BI Gateway), √© poss√≠vel criar exce√ß√µes espec√≠ficas usando uma pol√≠tica personalizada de acesso condicional. Verifique os logs de autentica√ß√£o para avaliar o uso atual desse fluxo antes de aplicar o bloqueio de forma ampla.üîç Como Identificar o Uso do Device Code FlowVoc√™ pode usar o Sign-in Logs do Microsoft Entra ID para encontrar eventos onde o Authentication Protocol √© definido como Device Code.Exemplo via Portal: V√° no Microsoft Entra &gt; Identity &gt; Monitoring &amp; health &gt; Sign-in logs; Aplique o filtro por Authentication Protocol: Device Code; Se houver autentica√ß√µes deste tipo, ser√£o apresentadas nos resultados da busca;Exemplo via Log Analytics (KQL):SigninLogs| where TimeGenerated &gt; ago(7d)| where AuthenticationProtocol == \"deviceCode\"| summarize by AppDisplayName, UserIdüîó Refer√™ncias Conditional Access: Authentication flows Protect your users from Device Code Flow abuse Microsoft-managed Conditional Access policies: Block device code flow Microsoft Entra Blog: New Microsoft-managed policies to raise your identity security posture‚úÖ Conclus√£oEmbora o Device Code Flow seja √∫til em cen√°rios leg√≠timos, ele tamb√©m representa um vetor de ataque explor√°vel, especialmente contra usu√°rios menos atentos. Ataques como o do STORM-2372 evidenciam a necessidade de rever continuamente as superf√≠cies de autentica√ß√£o permitidas no seu ambiente.A recomenda√ß√£o da Microsoft √© clara: bloqueie esse fluxo a menos que absolutamente necess√°rio e, mesmo nesse caso, aplique exce√ß√µes bem controladas e monitoradas.Proteger sua identidade na nuvem vai al√©m de MFA. Monitoramento cont√≠nuo, bloqueio de fluxos legados e pol√≠ticas de acesso adapt√°veis s√£o essenciais para manter sua organiza√ß√£o segura.√â isso meus amigos, at√© a pr√≥xima! ü§ò" }, { "title": "Primeiros Passos com o Microsoft Graph no PowerShell", "url": "/posts/MicrosoftGraph/", "categories": "PowerShell, Microsoft Graph", "tags": "Powershell, Microsoft365, Graph, Exchange, Teams, Entra ID, Sharepoint", "date": "2025-05-06 16:00:00 -0300", "snippet": " Ol√°, pessoal!Que tal come√ßarmos falando sobre PowerShell? E nada melhor do que iniciar com um dos m√≥dulos mais utilizados atualmente quando o assunto √© Microsoft Cloud (Azure / M365).O Microsoft ...", "content": " Ol√°, pessoal!Que tal come√ßarmos falando sobre PowerShell? E nada melhor do que iniciar com um dos m√≥dulos mais utilizados atualmente quando o assunto √© Microsoft Cloud (Azure / M365).O Microsoft Graph PowerShell √© um m√≥dulo moderno e poderoso que permite tamb√©m interagir com dados do Microsoft 365 de forma centralizada, segura e escal√°vel. Atrav√©s de cmdlets baseados em REST API, voc√™ pode consultar, gerenciar e automatizar tarefas envolvendo: Microsoft Entra ID Microsoft Teams Exchange Online SharePoint Online OneDrive Business Intune e muito mais.üß∞ Pr√©-requisitosAntes de utilizar o m√≥dulo, certifique-se de ter: PowerShell 5.1 ou superior (Windows) ou PowerShell 7+ (cross-platform) Sistema operacional: Windows 10/11, Windows Server, ou macOS/Linux com PowerShell 7 Permiss√µes adequadas para acessar os recursos do Microsoft 365 Install PowerShell for Windows Install PowerShell for Linux Install PowerShell for macOS üì¶ Instalando o M√≥duloExecute o seguinte comando no PowerShell com permiss√µes de administrador:Install-Module Microsoft.Graph -Scope CurrentUserüí° Se quiser instalar m√≥dulos espec√≠ficos (como Microsoft.Graph.Users), voc√™ pode especific√°-los:Install-Module Microsoft.Graph.Users -Scope CurrentUserüîê Autenticando no Microsoft GraphAntes de tudo: A API do Graph reconhece dois tipos de autentica√ß√£o, delegado e aplicativos.O acesso delegado permite que um aplicativo atue em nome de um usu√°rio autenticado, utilizando as permiss√µes atribu√≠das a esse usu√°rio. J√° o acesso de aplicativo (ou somente para aplicativos) permite que o aplicativo atue de forma aut√¥noma, como uma entidade pr√≥pria ‚Äî ideal para servi√ßos e scripts que n√£o dependem da intera√ß√£o direta de um usu√°rio.Se voc√™ precisa que a chamada de API seja executada com as permiss√µes de um usu√°rio espec√≠fico, utilize acesso delegado. Por outro lado, se est√° executando tarefas automatizadas, como scripts ou servi√ßos em segundo plano, opte pelo acesso de aplicativo.√â importante observar que algumas APIs s√≥ aceitam chamadas com acesso delegado, outras apenas com acesso de aplicativo, e h√° aquelas que funcionam com ambos os m√©todos.Durante o processo de autentica√ß√£o, √© essencial definir corretamente o escopo das permiss√µes solicitadas. Isso garante a aplica√ß√£o do princ√≠pio do menor privil√©gio, evitando a concess√£o de permiss√µes desnecess√°rias. Por exemplo:Connect-MgGraph -Scopes \"User.Read.All\",\"Group.ReadWrite.All\"Por√©m, tamb√©m √© poss√≠vel iniciar uma sess√£o, desta forma:Connect-MgGraphVoc√™ ser√° redirecionado para uma janela de login. Ap√≥s autentica√ß√£o, poder√° come√ßar a executar os cmdlets.Verifique os escopos e permiss√µes com:Get-MgContextüåê Exemplos de Comandos √öteisAbaixo est√£o alguns exemplos pr√°ticos do dia a dia:Listar os usu√°rios do Microsoft Entra IDGet-MgUser | Select-Object DisplayName, UserPrincipalName, AccountEnabledObter detalhes de um usu√°rio espec√≠ficoGet-MgUser -UserId \"usuario@dominio.com\"Listar todos os grupos do Microsoft 365Get-MgGroup | Select DisplayName, MailEnabled, SecurityEnabledObter caixas de correio (Exchange Online)Get-MgUser | Where-Object { $_.Mail -like \"*@dominio.com\" } | Select DisplayName, MailObter os membros de um grupoGet-MgGroupMember -GroupId \"id-do-grupo\"Para obter o ID de um grupo:Get-MgGroup | Format-Table DisplayName, Idüìò Dicas √∫teisVoc√™ pode carregar apenas os m√≥dulos necess√°rios para sua tarefa:Import-Module Microsoft.Graph.UsersCarregar apenas os comandos espec√≠ficos do m√≥dulo que voc√™ vai utilizar √© uma √≥tima pr√°tica ‚Äî sua m√°quina agradece. Importar todo o m√≥dulo do Microsoft Graph pode levar mais tempo, ent√£o essa √© uma boa alternativa quando voc√™ precisa de mais agilidade.Use Disconnect-MgGraph para encerrar a sess√£o com seguran√ßa.Para atualizar o m√≥dulo:Update-Module Microsoft.Graphüìö Documenta√ß√£o oficial Microsoft Graph PowerShell Docs Permiss√µes e escopos da API‚úÖ Conclus√£o√â isso meus amigos, hoje vamos ficar por aqui. Nos pr√≥ximos posts, veremos de forma mais avan√ßada como esse recurso pode ser extremamente √∫til.O m√≥dulo Microsoft Graph para PowerShell permite agilidade, centraliza√ß√£o e automa√ß√£o no gerenciamento de solu√ß√µes Microsoft 365. Dominar esse recurso transforma sua rotina de administra√ß√£o em algo muito mais eficiente e escal√°vel.Experimente, explore a documenta√ß√£o oficial e integre o Graph ao seu dia a dia e aos seus scripts!At√© a pr√≥xima! ü§ò" } ]
