<!doctype html><html lang="pt-BR" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="Configurações do Microsoft Entra PIM com PowerShell" /><meta name="author" content="Antonio Luciano" /><meta property="og:locale" content="pt_BR" /><meta name="description" content="A minimal, responsive and feature-rich Jekyll theme for technical writing." /><meta property="og:description" content="A minimal, responsive and feature-rich Jekyll theme for technical writing." /><link rel="canonical" href="https://tonho.cloud/posts/AzurePIM-Parte2/" /><meta property="og:url" content="https://tonho.cloud/posts/AzurePIM-Parte2/" /><meta property="og:site_name" content="Antonio Luciano" /><meta property="og:image" content="https://tonho.cloud/assets/images/Post05/post05-thumb2.png" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2025-07-12T19:00:00-03:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://tonho.cloud/assets/images/Post05/post05-thumb2.png" /><meta property="twitter:title" content="Configurações do Microsoft Entra PIM com PowerShell" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Antonio Luciano"},"dateModified":"2025-07-12T19:00:00-03:00","datePublished":"2025-07-12T19:00:00-03:00","description":"A minimal, responsive and feature-rich Jekyll theme for technical writing.","headline":"Configurações do Microsoft Entra PIM com PowerShell","image":"https://tonho.cloud/assets/images/Post05/post05-thumb2.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://tonho.cloud/posts/AzurePIM-Parte2/"},"url":"https://tonho.cloud/posts/AzurePIM-Parte2/"}</script><title>Configurações do Microsoft Entra PIM com PowerShell | Antonio&nbsp;Luciano</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Antonio&nbsp;Luciano"><meta name="application-name" content="Antonio&nbsp;Luciano"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.1/css/all.min.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.32.2/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css"><link rel="alternate" type="application/rss+xml" title="Tonho Cloud RSS Feed" href="/feed.xml"> <script src="/assets/js/dist/theme.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.13/dayjs.min.js,npm/dayjs@1.11.13/locale/pt.js,npm/dayjs@1.11.13/plugin/relativeTime.js,npm/dayjs@1.11.13/plugin/localizedFormat.js,npm/tocbot@4.32.2/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.min.js?baseurl=&register=true" ></script><link rel="icon" href="/assets/images/favicon.png" type="image/png"><link rel="stylesheet" href="/assets/css/custom.css"><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src="/assets/images/avatar.png" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a> <a class="site-title d-block" href="/">Antonio&nbsp;Luciano</a><p class="site-subtitle fst-italic mb-0">Cloud Security Expert <br> Microsoft Azure | Microsoft 365</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIAS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARQUIVOS</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/sobre/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>SOBRE</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="btn btn-link nav-link" aria-label="Switch Mode" id="mode-toggle"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/antonio-luciano" aria-label="github" target="_blank" rel="noopener noreferrer" > <i class="fab fa-github"></i> </a> <a href="https://www.linkedin.com/in/antoniolucianojunior/" aria-label="linkedin" target="_blank" rel="noopener noreferrer" > <i class="fab fa-linkedin"></i> </a> <a href="javascript:location.href = 'mailto:' + ['security','tonho.cloud'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">Home</a> </span> <span>Configurações do Microsoft Entra PIM com PowerShell</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link"> <i class="fas fa-search fa-fw"></i> </button> <search id="search" class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Buscar..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancelar</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="post"><header class="post-header"><h1 class="post-title">Configurações do Microsoft Entra PIM com PowerShell</h1><div class="post-meta"> <span class="post-author">Por Antonio Luciano</span> <span class="post-date">July 12, 2025</span></div></header><div class="post-content"><p><br /></p><p>Olá, pessoal!</p><p>Gerenciar acessos privilegiados em ambientes de nuvem é um dos maiores desafios de segurança atualmente. Por isso, o Microsoft Entra Privileged Identity Management (PIM) se torna uma peça essencial para qualquer organização que deseje proteger recursos sensíveis sem comprometer a produtividade.<br /> <small>Obs: O PIM exige licenciamento: Microsoft Entra ID P2, Microsoft 365 E5, Microsoft 365 E5 Security ou Enterprise Mobility + Security E5</small></p><p>Neste segundo post sobre o PIM, vamos ver como configurar alguns recursos via PowerShell. Isso me ajudou muito em um projeto de implantação do PIM, onde uma das etapas era a configuração de vários grupos e funções no PIM, e sem os scripts eu levaria muito mais tempo para finalizar.</p><p>Refrescando a memória de todos: O PIM é uma solução da Microsoft que permite conceder acessos privilegiados de forma just-in-time, ou seja, temporária, controlada e com requisitos adicionais de segurança, como autenticação multifator (MFA), justificativas e aprovações.</p><h4 id="então-com-o-pim-é-possível"><span class="me-2">Então com o PIM, é possível:</span><a href="#então-com-o-pim-é-possível" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>Controlar quem pode ativar funções privilegiadas;<br /><li>Exigir justificativas e MFA antes da ativação;<br /><li>Configurar limites de duração da sessão (ex: 4h);<br /><li>Gerar alertas e notificações sobre acessos e ativações;<br /><li>Delegar acesso sem adicionar diretamente permissões permanentes;<br /></ul><p>Bom, vamos lá! Há algumas estratégias para implementações, uma bastante utilizada, é a adoção de Grupos de Segurança do Microsoft Entra ID, definindo os grupos por ‘roles’ e/ou ‘subscriptions’, por exemplo. Vamos seguir desta forma (com grupos), pois é uma estratégia amplamente utilizada, e pouco demonstrada/utilizada nos laboratórios de procedimentos e vídeos de implementação do PIM.</p><p>Os grupos podem ser criados via PowerShell e depois associados às funções específicas dentro do PIM. Você pode criar um arquivo CSV e incluir o nome de todos os grupos que você deseja criar. Pode ser uma etapa importante, para já criar um padrão de nomenclatura dos grupos, nem que seja pelo menos para os grupos do PIM.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="nv">$csvPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"groups.csv"</span><span class="w">
</span><span class="nv">$groups</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Import-Csv</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="nv">$csvPath</span><span class="w">
</span><span class="kr">foreach</span><span class="w"> </span><span class="p">(</span><span class="nv">$group</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nv">$groups</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="n">New-AzureADMSGroup</span><span class="w"> </span><span class="nt">-DisplayName</span><span class="w"> </span><span class="nv">$group</span><span class="o">.</span><span class="nf">GroupName</span><span class="w"> </span><span class="se">`
</span><span class="w">     </span><span class="nt">-MailEnabled</span><span class="w"> </span><span class="bp">$false</span><span class="w"> </span><span class="se">`
</span><span class="w">     </span><span class="nt">-MailNickName</span><span class="w"> </span><span class="nv">$group</span><span class="o">.</span><span class="nf">GroupName</span><span class="w"> </span><span class="se">`
</span><span class="w">     </span><span class="nt">-SecurityEnabled</span><span class="w"> </span><span class="bp">$true</span><span class="w"> </span><span class="se">`
</span><span class="w">     </span><span class="nt">-IsAssignableToRole</span><span class="w"> </span><span class="bp">$true</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="n">Write-Output</span><span class="w"> </span><span class="s2">"Grupos criados e processo concluido."</span><span class="w">
</span></pre></table></code></div></div><blockquote><p><small> Importante definir o parâmetro “IsAssignableToRole” como $true para que o grupo possa receber atribuições de funções.</small></p></blockquote><h2 id="️-automações-via-powershell"><span class="me-2">⚙️ Automações via PowerShell</span><a href="#️-automações-via-powershell" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h4 id="obter-informações-dos-grupos"><span class="me-2">Obter informações dos grupos</span><a href="#obter-informações-dos-grupos" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Se você for utilizar Grupos de Segurança, você deve primeiro obter o <strong>ObjectId</strong> dos grupos que você criou para o PIM.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Get-MgPolicyRoleManagementPolicy</span><span class="w"> </span><span class="nt">-Filter</span><span class="w"> </span><span class="s2">"scopeId eq '&lt;GroupId&gt;' and scopeType eq 'Group'"</span><span class="w">
</span></pre></table></code></div></div><p>Salve estes IDs em um arquivo CSV para seguirmos para a próxima etapa. Vamos obter agora o “PolicyID Group”, que é diferente do GroupID. Aqui, você irá obter o ID das políticas do PIM for Groups.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="bp">$input</span><span class="n">FilePath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"input.csv"</span><span class="w">
</span><span class="nv">$outputFilePath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"output.csv"</span><span class="w">
</span><span class="nv">$scopeIDs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Import-Csv</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="bp">$input</span><span class="nx">FilePath</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Select-Object</span><span class="w"> </span><span class="nt">-ExpandProperty</span><span class="w">
</span><span class="n">scopeID</span><span class="w">
</span><span class="nv">$resultados</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@()</span><span class="w">
</span><span class="kr">foreach</span><span class="w"> </span><span class="p">(</span><span class="nv">$scopeID</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nv">$scopeIDs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="nv">$policy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-MgPolicyRoleManagementPolicy</span><span class="w"> </span><span class="nt">-Filter</span><span class="w"> </span><span class="s2">"scopeId eq '</span><span class="nv">$scopeID</span><span class="s2">'
and scopeType eq 'Group'"</span><span class="w">
  </span><span class="nv">$resultados</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nv">$policy</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="nv">$resultados</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Export-Csv</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="nv">$outputFilePath</span><span class="w"> </span><span class="nt">-NoTypeInformation</span><span class="w">
</span></pre></table></code></div></div><blockquote><p><small>Você verá que os IDs exportados possuem muito mais caracteres do que os ObjectIDs dos grupos. O resultado é a “concatenação” do ID do Grupo + ID das políticas do PIM for Groups.</small></p></blockquote><h4 id="configurações-do-pim"><span class="me-2">Configurações do PIM</span><a href="#configurações-do-pim" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>As imagens abaixo, vão ajudar a entender, onde é aplicado cada uma das configurações realizadas através dos scripts, que veremos a seguir.</p><div style="text-align: center;"> <a href="/assets/images/Post06/pim-ux-role-rule.activation.png" class="popup img-link shimmer"><img src="/assets/images/Post06/pim-ux-role-rule.activation.png" alt="PIM-Activation" width="500" height="700" style="display: inline-block; margin: 0;" loading="lazy"></a></div><div style="text-align: center;"> <a href="/assets/images/Post06/pim-ux-role-rule.assignment.png" class="popup img-link shimmer"><img src="/assets/images/Post06/pim-ux-role-rule.assignment.png" alt="PIM-Assignment" width="600" height="800" style="display: inline-block; margin: 0;" loading="lazy"></a></div><p><a href="/assets/images/Post06/pim-ux-role-rule.notification.png" class="popup img-link shimmer"><img src="/assets/images/Post06/pim-ux-role-rule.notification.png" alt="MFA-Notification" loading="lazy"></a></p><p>Os scripts para as configurações do PIM, utilizam o módulo do <a href="https://learn.microsoft.com/en-us/powershell/microsoftgraph/installation?view=graph-powershell-1.0" target="_blank" rel="noopener noreferrer">Microsoft Graph para Powershell</a>. Você pode baixar os scripts no seguinte link: <a href="https://github.com/antonio-luciano/tonhocloud/tree/main/PIM%20Settings" target="_blank" rel="noopener noreferrer">GitHub - PIM Settings PowerShell</a><br /></p><div class="table-wrapper"><table><thead><tr><th>Number<th>Script<th>Description<tbody><tr><td>1<td>DurationTime.ps1<td>Configuração do tempo de ativação da função.<tr><td>3<td>ConditionalAccess.ps1<td>Solicitação do MFA através de Conditional Access<br /> para ativação da função.<tr><td>9<td>Notification_Admin_Admin_Eligibility.ps1<td>Notificações aos “Administradores” quando um<br /> usuário for atribuído como “Elegível”.<tr><td>10<td>Notification_Requestor_Admin_Eligibility.ps1<td>Notificações aos “Solicitantes” quando um<br /> usuário for atribuído como “Elegível”.<tr><td>11<td>Notification_Approver_Admin_Eligibility.ps1<td>Notificações aos “Aprovadores” quando um<br /> usuário for atribuído como “Elegível”.<tr><td>12<td>Notification_Admin_Admin_Assignment.ps1<td>Notificações aos Administradores quando um<br /> usuário for atribuído como “Ativo”.<tr><td>13<td>Notification_Requestor_Admin_Assignment.ps1<td>Notificações aos “Solicitantes” quando um<br /> usuário for atribuído como “Ativo”.<tr><td>14<td>Notification_Approver_Admin_Assignment.ps1<td>Notificações aos “Aprovadores” quando um<br /> usuário for atribuído como “Ativo”.<tr><td>15<td>Notification_Admin_EndUser_Assignment.ps1<td>Notificações aos Administradores quando um<br /> usuário “Elegível” ativar a função.<tr><td>16<td>Notification_Requestor_EndUser_Assignment.ps1<td>Notificações aos “Solicitantes” quando um<br /> usuário “Elegível” ativar a função.<tr><td>17<td>Notification_Approver_EndUser_Assignment.ps1<td>Notificações aos “Aprovadores” quando um<br /> usuário “Elegível” ativar a função.</table></div><blockquote><p><small>Todos os scripts .ps1 no GitHub iniciam o nome com “PIM-Settings” (Ex: PIM-Settings_DurationTime.ps1). Porém, removi desta tabela, para ter mais espaço e ficar um pouco mais harmonioso, rs.</small></p></blockquote><p>As configurações dos parâmetros dos grupos no PIM, podem ser totalmente automatizadas por scripts. Cada grupo ou função passa por uma série de definições:</p><ul><li>Duração de ativação: 4 horas (exemplo);<br /><li>MFA obrigatório via política de acesso condicional;<br /><li>Notificações ativadas/desativadas dependendo do tipo de usuário (Admin, Solicitante ou Aprovador);<br /><li>Controle de notificações para atribuições e ativações;<br /></ul><p>Além disso, os scripts também podem ser utilizados para:</p><ul><li>Realizar o onboarding dos grupos no PIM;<br /><li>Aplicar políticas de expiração e autenticação;<br /><li>Listar todos os usuários elegíveis a ativar funções dentro do PIM;<br /><li>Exigência de MFA via Contexto de Autenticação (aqui tem um pulo do gato);<br /></ul><h4 id="solicitar-mfa-para-ativar-função-no-pim"><span class="me-2">Solicitar MFA para ativar função no PIM</span><a href="#solicitar-mfa-para-ativar-função-no-pim" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Uma política de acesso condicional deve ser criada com um <strong>Authentication Context</strong>, caso você queira exigir o MFA toda vez que um usuário ativar uma função no PIM. Isso cria uma camada adicional de proteção, garantindo que apenas usuários validados e confiáveis executem ações sensíveis. E aqui esta o “segredo”, o Authentication Context. Você precisa dele se quiser utilizar o MFA cada vez que for ativar uma função através do PIM. Não adianta apenas marcar o <strong>Azure MFA</strong> nas configurações da função ou do grupo, que não irá funcionar como o esperado. Com a opção Azure MFA, os usuários podem não ser solicitados a efetuar autenticação multifator se tiverem se autenticado com credenciais fortes ou fornecido autenticação multifator anteriormente na sessão.</p><p>Nas configurações (Settings) do grupo, selecione <strong>Microsoft Entra Conditional Access authentication context</strong>:</p><div style="text-align: center;"> <a href="/assets/images/Post06/mfa-pim.png" class="popup img-link shimmer"><img src="/assets/images/Post06/mfa-pim.png" alt="MFA-PIM" width="600" height="800" style="display: inline-block; margin: 0;" loading="lazy"></a></div><h4 id="authentication-context"><span class="me-2">Authentication Context</span><a href="#authentication-context" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Também será necessário configurarmos um <strong>Conditional Access</strong>. Mas antes, vamos criar o <strong>Authentication Context</strong>.</p><ol><li>Vá até <strong>Entra ID &gt; Conditional Access &gt; Authentication context</strong>;<li><strong>New authentication context</strong> &gt; Dê um nome, uma descrição e escolha um ID;<li>Clique em <strong>Save</strong>;</ol><p><a href="/assets/images/Post06/auth-context.png" class="popup img-link shimmer"><img src="/assets/images/Post06/auth-context.png" alt="Authentication-Context" loading="lazy"></a></p><h4 id="conditional-access"><span class="me-2">Conditional Access</span><a href="#conditional-access" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Crie uma nova política de acesso condicional e faça o seguinte:</p><p>. <span style="color:orange">Users:</span> Selecione os grupos/usuários que você quer aplicar;<br /> . <span style="color:orange">Target resources:</span> <em>Select what this policy applies to</em>: <strong>Authentication Context</strong>;<br /> . <span style="color:orange">Authentication Context:</span> Selecione o que você criou anteriormente;<br /> . <span style="color:orange">Grant:</span> Selecione <strong>Require authentication strength</strong> com a opção <strong>Multifactor Authentication</strong>;<br /> . <span style="color:orange">Session:</span> <strong>Sign-in frequency - Every time</strong>;<br /> . <span style="color:orange">Enable policy:</span> <strong>On</strong>;</p><p><a href="/assets/images/Post06/cond-access.png" class="popup img-link shimmer"><img src="/assets/images/Post06/cond-access.png" alt="Conditional-Access" loading="lazy"></a></p><p>Podemos ver através das configurações do grupo em questão, que o Authentication Context esta definido:</p><p><a href="/assets/images/Post06/config-group-pim.png" class="popup img-link shimmer"><img src="/assets/images/Post06/config-group-pim.png" alt="Config-Group-PIM" loading="lazy"></a></p><p>Agora é só testar e… Voilà!</p><p><a href="/assets/images/Post06/activate-pim.png" class="popup img-link shimmer"><img src="/assets/images/Post06/activate-pim.png" alt="Activate-PIM" loading="lazy"></a></p><blockquote><p><small>Sempre que for ativar uma função ou atribuição ao grupo do PIM, será solicitado o MFA.</small></p></blockquote><h2 id="-bônus-listar-usuários-elegíveis-dos-grupos-no-pim"><span class="me-2">🔍 Bônus: Listar usuários elegíveis dos Grupos no PIM</span><a href="#-bônus-listar-usuários-elegíveis-dos-grupos-no-pim" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Os usuários elegíveis aos grupos de segurança no PIM, podem ser visualizados através do Portal da Azure, de forma individual, escolhendo o grupo e visualizando os usuários elegíveis (conforme imagem abaixo), mas como a ideia aqui é utilizar o Microsoft Graph via Powershell, vamos fazer isso através de script! O script abaixo, exporta para um arquivo CSV os usuários elegíves de todos os grupos do PIM, neste exemplo, grupos que iniciam com o nome “G-PIM” (como é bom ter um padrão de nomenclatura, hein?!).</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre><span class="n">Connect-MgGraph</span><span class="w"> </span><span class="nt">-Scopes</span><span class="w"> </span><span class="s2">"Group.Read.All"</span><span class="p">,</span><span class="w"> </span><span class="s2">"User.Read.All"</span><span class="w">
</span><span class="nv">$outputCsvPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"C:\Temp\EligibleUsers_PIMforGroups_G-PIM.csv"</span><span class="w">
</span><span class="nv">$results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@()</span><span class="w">
</span><span class="nv">$groups</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-MgGroup</span><span class="w"> </span><span class="nt">-Filter</span><span class="w"> </span><span class="s2">"startswith(DisplayName, 'G-PIM')"</span><span class="w"> </span><span class="nt">-Property</span><span class="w"> </span><span class="nx">Id</span><span class="p">,</span><span class="w"> </span><span class="nx">DisplayName</span><span class="w">

</span><span class="kr">foreach</span><span class="w"> </span><span class="p">(</span><span class="nv">$group</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nv">$groups</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="nv">$groupId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$group</span><span class="o">.</span><span class="nf">Id</span><span class="w">
  </span><span class="nv">$members</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-MgBetaIdentityGovernancePrivilegedAccessGroupEligibilitySchedule</span><span class="w"> </span><span class="nt">-Filter</span><span class="w"> </span><span class="s2">"groupId eq '</span><span class="nv">$groupId</span><span class="s2">'"</span><span class="w">

  </span><span class="kr">foreach</span><span class="w"> </span><span class="p">(</span><span class="nv">$member</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nv">$members</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
     </span><span class="nv">$user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-MgUser</span><span class="w"> </span><span class="nt">-UserId</span><span class="w"> </span><span class="nv">$member</span><span class="o">.</span><span class="nf">PrincipalId</span><span class="w"> </span><span class="nt">-Property</span><span class="w"> </span><span class="nx">Id</span><span class="p">,</span><span class="w"> </span><span class="nx">DisplayName</span><span class="p">,</span><span class="w"> </span><span class="nx">UserPrincipalName</span><span class="p">,</span><span class="w"> </span><span class="nx">AccountEnabled</span><span class="w">

     </span><span class="nv">$result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">PSCustomObject</span><span class="p">]@{</span><span class="w">
       </span><span class="nx">GroupId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$group</span><span class="err">.</span><span class="nx">Id</span><span class="w">
       </span><span class="nx">GroupName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$group</span><span class="err">.</span><span class="nx">DisplayName</span><span class="w">
       </span><span class="nx">UserId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$user</span><span class="err">.</span><span class="nx">Id</span><span class="w">
       </span><span class="nx">UserDisplayName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$user</span><span class="err">.</span><span class="nx">DisplayName</span><span class="w">
       </span><span class="nx">UserPrincipalName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$user</span><span class="err">.</span><span class="nx">UserPrincipalName</span><span class="w">
       </span><span class="nx">AccountEnabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$user</span><span class="err">.</span><span class="nx">AccountEnabled</span><span class="w">
     </span><span class="p">}</span><span class="w">
     </span><span class="nv">$results</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nv">$result</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="nv">$results</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Export-Csv</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="nv">$outputCsvPath</span><span class="w"> </span><span class="nt">-NoTypeInformation</span><span class="w"> </span><span class="nt">-Encoding</span><span class="w"> </span><span class="nx">UTF8</span><span class="w">
</span><span class="n">Write-Output</span><span class="w"> </span><span class="s2">"Os dados foram exportados para </span><span class="nv">$outputCsvPath</span><span class="s2">"</span><span class="w">
</span></pre></table></code></div></div><blockquote><p><small>É uma boa forma de criar um <em>report</em> de quais usuários são elegíveis aos grupos do PIM.</small></p></blockquote><h2 id="-documentação-oficial"><span class="me-2">📚 Documentação oficial</span><a href="#-documentação-oficial" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>📖 <a href="https://learn.microsoft.com/en-us/entra/id-governance/privileged-identity-management/pim-configure" target="_blank" rel="noopener noreferrer">Microsoft Entra PIM</a><br /> 📖 <a href="https://learn.microsoft.com/en-us/graph/identity-governance-pim-rules-overview" target="_blank" rel="noopener noreferrer">Rules in PIM - Mapping guide</a><br /> 📖 <a href="https://learn.microsoft.com/en-us/entra/identity/conditional-access/concept-conditional-access-cloud-apps#configure-authentication-contexts" target="_blank" rel="noopener noreferrer">Configure authentication contexts</a></p><h2 id="-conclusão"><span class="me-2">✅ Conclusão</span><a href="#-conclusão" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>O PIM é uma ferramenta poderosa para reduzir riscos, reforçar controles e garantir que o princípio do menor privilégio seja uma realidade no seu ambiente Microsoft. Se você ainda não está usando o PIM no seu ambiente, este é um excelente momento para começar a planejar! Ainda mais agora, que você possui dicas valiosas (e scripts) de como executar algumas ações.</p><p>Bom, fechamos aqui. Até a próxima! 🤘</p></div><div class="post-share"> <span class="share-label">Compartilhe</span><div class="share-icons"> <a href="https://x.com/intent/tweet?url=https://tonho.cloud/posts/AzurePIM-Parte2/" target="_blank" title="X"> <i class="fab fa-x-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?u=https://tonho.cloud/posts/AzurePIM-Parte2/" target="_blank" title="Facebook"> <i class="fab fa-facebook"></i> </a> <a href="https://api.whatsapp.com/send?text=https://tonho.cloud/posts/AzurePIM-Parte2/" target="_blank" title="WhatsApp"> <i class="fab fa-whatsapp"></i> </a> <a href="https://t.me/share/url?url=https://tonho.cloud/posts/AzurePIM-Parte2/" target="_blank" title="Telegram"> <i class="fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://tonho.cloud/posts/AzurePIM-Parte2/" target="_blank" title="LinkedIn"> <i class="fab fa-linkedin"></i> </a> <a href="#" onclick="navigator.clipboard.writeText('https://tonho.cloud/posts/AzurePIM-Parte2/'); alert('Link copiado!'); return false;" title="Copiar link"> <i class="fas fa-link"></i> </a></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Atualizados recentemente</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/AzurePIM-Parte2/">Configurações do Microsoft Entra PIM com PowerShell</a><li class="text-truncate lh-lg"> <a href="/posts/AzurePIM/">Mapeamento de Rule IDs no Microsoft Entra PIM</a><li class="text-truncate lh-lg"> <a href="/posts/WallpaperIntune/">Definir Wallpaper via Intune com Atualização Dinâmica</a><li class="text-truncate lh-lg"> <a href="/posts/PhishingProtection/">Como habilitar o Enhanced Phishing Protection</a><li class="text-truncate lh-lg"> <a href="/posts/AuthenticationFlow/">Como se proteger contra abusos de Device Code Flow</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/entra-id/">Entra ID</a> <a class="post-tag btn btn-outline-primary" href="/tags/microsoft365/">Microsoft365</a> <a class="post-tag btn btn-outline-primary" href="/tags/azure/">Azure</a> <a class="post-tag btn btn-outline-primary" href="/tags/endpoint/">Endpoint</a> <a class="post-tag btn btn-outline-primary" href="/tags/intune/">Intune</a> <a class="post-tag btn btn-outline-primary" href="/tags/least-privilege/">Least Privilege</a> <a class="post-tag btn btn-outline-primary" href="/tags/microsoft-365/">Microsoft 365</a> <a class="post-tag btn btn-outline-primary" href="/tags/pim/">PIM</a> <a class="post-tag btn btn-outline-primary" href="/tags/azure-ad/">Azure AD</a> <a class="post-tag btn btn-outline-primary" href="/tags/conditional-access/">Conditional Access</a></div></section></div></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><footer class="footer"><div class="footer__hr"></div><div class="footer__bottom"><p>© 2025 <strong>Antonio Luciano</strong>. Alguns direitos reservados.</p></div></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center d-none"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/entra-id/">Entra ID</a> <a class="post-tag btn btn-outline-primary" href="/tags/microsoft365/">Microsoft365</a> <a class="post-tag btn btn-outline-primary" href="/tags/azure/">Azure</a> <a class="post-tag btn btn-outline-primary" href="/tags/endpoint/">Endpoint</a> <a class="post-tag btn btn-outline-primary" href="/tags/intune/">Intune</a> <a class="post-tag btn btn-outline-primary" href="/tags/least-privilege/">Least Privilege</a> <a class="post-tag btn btn-outline-primary" href="/tags/microsoft-365/">Microsoft 365</a> <a class="post-tag btn btn-outline-primary" href="/tags/pim/">PIM</a> <a class="post-tag btn btn-outline-primary" href="/tags/azure-ad/">Azure AD</a> <a class="post-tag btn btn-outline-primary" href="/tags/conditional-access/">Conditional Access</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div><aside id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">Uma nova versão do conteúdo está disponível.</p><button type="button" class="btn btn-primary" aria-label="Update"> atualização </button></div></aside><script> document.addEventListener('DOMContentLoaded', () => { SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{snippet}</p></article>', noResultsText: '<p class="mt-5">Oops! Nenhum resultado encontrado.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); }); </script>
