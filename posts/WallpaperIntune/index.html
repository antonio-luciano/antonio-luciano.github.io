<!doctype html><html lang="pt-BR" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="Definir Wallpaper via Intune com Atualização Dinâmica" /><meta name="author" content="Antonio Luciano" /><meta property="og:locale" content="pt_BR" /><meta name="description" content="A minimal, responsive and feature-rich Jekyll theme for technical writing." /><meta property="og:description" content="A minimal, responsive and feature-rich Jekyll theme for technical writing." /><link rel="canonical" href="https://tonho.cloud/posts/WallpaperIntune/" /><meta property="og:url" content="https://tonho.cloud/posts/WallpaperIntune/" /><meta property="og:site_name" content="Antonio Luciano" /><meta property="og:image" content="https://tonho.cloud/assets/images/Post04/post04-thumb.png" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2025-05-30T16:00:00-03:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://tonho.cloud/assets/images/Post04/post04-thumb.png" /><meta property="twitter:title" content="Definir Wallpaper via Intune com Atualização Dinâmica" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Antonio Luciano"},"dateModified":"2025-05-30T16:00:00-03:00","datePublished":"2025-05-30T16:00:00-03:00","description":"A minimal, responsive and feature-rich Jekyll theme for technical writing.","headline":"Definir Wallpaper via Intune com Atualização Dinâmica","image":"https://tonho.cloud/assets/images/Post04/post04-thumb.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://tonho.cloud/posts/WallpaperIntune/"},"url":"https://tonho.cloud/posts/WallpaperIntune/"}</script><title>Definir Wallpaper via Intune com Atualização Dinâmica | Antonio&nbsp;Luciano</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Antonio&nbsp;Luciano"><meta name="application-name" content="Antonio&nbsp;Luciano"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.32.2/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css"><link rel="alternate" type="application/rss+xml" title="Tonho Cloud RSS Feed" href="/feed.xml"> <script src="/assets/js/dist/theme.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.13/dayjs.min.js,npm/dayjs@1.11.13/locale/pt.js,npm/dayjs@1.11.13/plugin/relativeTime.js,npm/dayjs@1.11.13/plugin/localizedFormat.js,npm/tocbot@4.32.2/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.min.js?baseurl=&register=true" ></script><link rel="icon" href="/assets/images/favicon.png" type="image/png"><link rel="stylesheet" href="/assets/css/custom.css"><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src="/assets/images/avatar.png" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a> <a class="site-title d-block" href="/">Antonio&nbsp;Luciano</a><p class="site-subtitle fst-italic mb-0">Cloud Security Expert <br> Microsoft Azure | Microsoft 365</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIAS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARQUIVOS</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/sobre/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>SOBRE</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="btn btn-link nav-link" aria-label="Switch Mode" id="mode-toggle"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/antonio-luciano" aria-label="github" target="_blank" rel="noopener noreferrer" > <i class="fab fa-github"></i> </a> <a href="https://www.linkedin.com/in/antoniolucianojunior/" aria-label="linkedin" target="_blank" rel="noopener noreferrer" > <i class="fab fa-linkedin"></i> </a> <a href="javascript:location.href = 'mailto:' + ['security','tonho.cloud'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">Home</a> </span> <span>Definir Wallpaper via Intune com Atualização Dinâmica</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link"> <i class="fas fa-search fa-fw"></i> </button> <search id="search" class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Buscar..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancelar</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="post"><header class="post-header"><h1 class="post-title">Definir Wallpaper via Intune com Atualização Dinâmica</h1><div class="post-meta"> <span class="post-author">Por Antonio Luciano</span> <span class="post-date">May 30, 2025</span></div></header><div class="post-content"><p><br /></p><p>Olá, pessoal!</p><p>Aplicação do papel de parede nos computadores da companhia, é uma tarefa muito normal em praticamente todas as empresas, não é verdade. E executar esta modesta atividade via Microsoft Intune parece simples à primeira vista, no entanto, quem já tentou fazer isso em máquinas com <strong>Windows 10/11 Pro</strong> sabe que a abordagem padrão, usando perfis de restrição de dispositivo, esbarra em algumas limitações.</p><p>Este post, inspirado no excelente artigo do MVP ‘Gannon Novak’ do site <a href="https://smbtothecloud.com" target="_blank" rel="noopener noreferrer">SMBtotheCloud</a> vai lhe mostrar através de uma solução alternativa e robusta, como usar scripts PowerShell e a implantação de aplicativos Win32 no Microsoft Intune para aplicar este tipo de configuração. Vamos não apenas configurar o Wallpaper, mas também implementar um método inteligente para atualizá-lo dinamicamente, sem a necessidade de reempacotar e redistribuir o aplicativo a cada mudança.</p><h2 id="o-desafio-por-que-o-método-padrão-falha-no-windows-10-pro"><span class="me-2">O Desafio: Por que o método padrão falha no Windows 10 Pro?</span><a href="#o-desafio-por-que-o-método-padrão-falha-no-windows-10-pro" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>A forma mais direta de configurar o papel de parede no Intune é através de um Perfil de Configuração de Dispositivo &gt; Restrições de Dispositivo. Lá, você encontra opções para especificar URLs para as imagens desejadas. Simples, certo? O problema é que essas configurações específicas são aplicáveis apenas às edições <strong>Enterprise</strong> e <strong>Education</strong> do Windows 10/11. <br /> Ao tentar aplicar esse perfil a um dispositivo com Windows 10/11 Pro, o status da política no Intune mostrará “Não aplicável”. Frustrante, né? Precisamos, então, de um caminho alternativo. Bora! 😉</p><h2 id="a-solução-scripts-powershell-e-o-registro-do-windows"><span class="me-2">A Solução: Scripts PowerShell e o Registro do Windows</span><a href="#a-solução-scripts-powershell-e-o-registro-do-windows" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Quando as políticas padrão não funcionam, muitas vezes a solução está em manipular diretamente o Registro do Windows. É exatamente isso que faremos! Usaremos scripts PowerShell para:</p><ul><li>Criar as chaves e valores necessários no registro para definir as imagens;<li>Baixar as imagens desejadas de um local acessível (como o Azure Blob Storage);<li>Configurar o sistema para usar essas imagens baixadas;</ul><p>Para distribuir e executar esses scripts de forma gerenciada através do Intune, utilizaremos o recurso de implantação de Aplicativos Win32.</p><p><strong>Parte 1:</strong> O Script de Instalação (Configuração Inicial)</p><p>O primeiro passo é criar um script PowerShell que fará a configuração inicial. Este script será empacotado como um aplicativo Win32. Veja o código abaixo, com explicações:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre><span class="c"># Garante que o caminho base no registro exista, senão será criado</span><span class="w">
</span><span class="n">New-Item</span><span class="w"> </span><span class="nx">HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\PersonalizationCSP</span><span class="w"> </span><span class="nt">-Force</span><span class="w">

</span><span class="c"># Caminho base no registro onde as configurações serão aplicadas</span><span class="w">
</span><span class="nv">$RegPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\PersonalizationCSP"</span><span class="w">

</span><span class="c"># URL da imagem (substitua pelo seu link - Ex: Azure Blob Storage)</span><span class="w">
</span><span class="nv">$BackgroundImageURL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'https://seu_storage.blob.core.windows.net/wallpaper/background.jpg'</span><span class="w">

</span><span class="c"># Pasta local onde a imagem será salva no cliente</span><span class="w">
</span><span class="nv">$ImageDestinationFolder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"C:\MDM\images"</span><span class="w">

</span><span class="c"># Caminho completo para o arquivo da imagem local</span><span class="w">
</span><span class="nv">$Backgroundimage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"</span><span class="nv">$ImageDestinationFolder</span><span class="s2">\background.jpg"</span><span class="w">

</span><span class="c"># Cria a pasta C:\MDM\images se ela não existir. O -ErrorAction SilentlyContinue evita erros caso a pasta já exista.</span><span class="w">
</span><span class="n">md</span><span class="w"> </span><span class="nv">$ImageDestinationFolder</span><span class="w"> </span><span class="nt">-ErrorAction</span><span class="w"> </span><span class="nx">SilentlyContinue</span><span class="w">

</span><span class="c"># Usa o BITS (Background Intelligent Transfer Service) para baixar a imagem da URL especificada</span><span class="w">
</span><span class="n">Start-BitsTransfer</span><span class="w"> </span><span class="nt">-Source</span><span class="w"> </span><span class="nv">$BackgroundImageURL</span><span class="w"> </span><span class="nt">-Destination</span><span class="w"> </span><span class="s2">"</span><span class="nv">$Backgroundimage</span><span class="s2">"</span><span class="w">

</span><span class="c"># Configuração das Chaves do Registro para o Papel de Parede</span><span class="w">
</span><span class="n">New-ItemProperty</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="nv">$RegPath</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="nx">DesktopImagePath</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="nv">$backgroundimage</span><span class="w"> </span><span class="nt">-PropertyType</span><span class="w"> </span><span class="nx">String</span><span class="w"> </span><span class="nt">-Force</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Out-Null</span><span class="w">
</span><span class="nx">New-ItemProperty</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="nv">$RegPath</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="nx">DesktopImageUrl</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="nv">$backgroundimage</span><span class="w"> </span><span class="nt">-PropertyType</span><span class="w"> </span><span class="nx">String</span><span class="w"> </span><span class="nt">-Force</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Out-Null</span><span class="w">
</span><span class="nx">New-ItemProperty</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="nv">$RegPath</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="nx">DesktopImageStatus</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="nx">1</span><span class="w"> </span><span class="nt">-PropertyType</span><span class="w"> </span><span class="nx">DWORD</span><span class="w"> </span><span class="nt">-Force</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Out-Null</span><span class="w">

</span><span class="kr">exit</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span></pre></table></code></div></div><p>Pontos importantes sobre este script:<br /></p><ul><li><strong>URL da Imagem:</strong> Você precisa substituir a URL de exemplo ($BackgroundImageURL) pela URL real onde sua imagem está hospedada. O Azure Blob Storage é uma ótima opção, garantindo que a imagem esteja acessível publicamente (ou via SAS token, se necessário, mas o script assume acesso anônimo aqui).<br /><li><strong>Nome do Arquivo:</strong> O script assume que a imagem se chamará ‘background.jpg’. Manter esse nome é crucial para o funcionamento do script de detecção que veremos a seguir. Se mudar o nome do arquivo, não esqueça de mudar no script.<br /><li><strong>Pasta de Destino:</strong> A imagem é salva em ‘C:\MDM\Images’. Certifique-se de que não haja políticas bloqueando a criação ou escrita nesta pasta, ou ajuste o caminho ($ImageDestinationFolder) conforme necessário.<br /></ul><blockquote><p>O script então, baixa a imagem e configura o registro para usá-lá como papel de parede.</p></blockquote><p>Abaixo, o script de <strong>Uninstall</strong>, que nada mais é que, a remoção das chaves de registro:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="n">Remove-ItemProperty</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="s2">"HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\PersonalizationCSP"</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s2">"DesktopImagePath"</span><span class="w">
</span><span class="n">Remove-ItemProperty</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="s2">"HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\PersonalizationCSP"</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s2">"DesktopImageUrl"</span><span class="w">
</span><span class="n">Remove-ItemProperty</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="s2">"HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\PersonalizationCSP"</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s2">"DesktopImageStatus"</span><span class="w">
</span><span class="kr">exit</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span></pre></table></code></div></div><h2 id="parte-2-o-desafio-da-atualização-e-o-script-de-detecção-inteligente"><span class="me-2">Parte 2: O Desafio da Atualização e o Script de Detecção Inteligente</span><a href="#parte-2-o-desafio-da-atualização-e-o-script-de-detecção-inteligente" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Ok, a configuração inicial está resolvida. Mas e se a empresa quiser trocar as imagens sazonalmente, ou para campanhas específicas? Com a abordagem Win32 App padrão, teríamos que:</p><ul><li>Atualizar as imagens no Blob Storage;<li>(Potencialmente) Alterar o script de instalação se algo mudasse;<li>Reempacotar o script usando a Ferramenta de Preparação de Conteúdo Win32 da Microsoft (IntuneWinAppUtil.exe);<li>Fazer upload da nova versão do arquivo .intunewin para o Intune;<li>Aguardar a distribuição e instalação nos clientes;</ul><p>Isso é trabalhoso e propenso a erros. A beleza da solução proposta pelo ‘Gannon Novak’ está no script de detecção personalizado. O Intune, ao implantar um aplicativo Win32, usa regras de detecção para verificar se o aplicativo já está instalado corretamente. Normalmente, isso envolve verificar a existência de um arquivo, pasta ou chave de registro específica. No nosso caso, usaremos um script PowerShell personalizado como regra de detecção.</p><p>Este script de detecção fará o seguinte:</p><ul><li>Baixará a versão atual da imagem (background.jpg) do Blob Storage para uma pasta temporária;<li>Comparará a data/hora da última modificação (timestamp) dessa imagem recém-baixada com a imagem que já está na pasta C:\MDM\images do cliente;<li>Verificará também se as chaves de registro relevantes estão configuradas corretamente;<li>Se o timestamp da imagem local e remota coincidirem e as chaves de registro estiverem corretas, o script retornará <strong>“Detected”</strong> (indicando que a versão correta já está instalada).<li>Se os timestamp diferirem (significando que a imagem no Blob Storage foi atualizada) ou se as chaves de registro estiverem incorretas, o script sairá com um código de erro (exit 1), sinalizando ao Intune que a “aplicação” (nossa imagem e configurações) não está no estado desejado. Isso fará com que o Intune execute novamente o script de instalação (Parte 1), que baixará a nova imagem e reconfigurará o registro. Genial, não? Isso permite que você simplesmente substitua o arquivo background.jpg no seu Blob Storage. Na próxima vez que o Intune avaliar a política de detecção nos clientes (o que ocorre periodicamente), ele perceberá a mudança nos timestamps e automaticamente executará o script de instalação para atualizar a imagem nos endpoints, sem nenhuma intervenção manual no Intune!</ul><p><strong>Script de detecção:</strong></p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
</pre><td class="rouge-code"><pre><span class="c"># URL da imagem (DEVE ser a mesma do script de instalação)</span><span class="w">
</span><span class="nv">$BackgroundImageURL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'https://seu_storage.blob.core.windows.net/wallpaper/background.jpg'</span><span class="w">

</span><span class="c"># Pasta temporária para baixar a imagem para verificação</span><span class="w">
</span><span class="nv">$TempImageDestinationFolder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"C:\MDM\images\temp"</span><span class="w">

</span><span class="c"># Caminho completo para o arquivo temporário</span><span class="w">
</span><span class="nv">$TempBackgroundimage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"</span><span class="nv">$TempImageDestinationFolder</span><span class="s2">\background.jpg"</span><span class="w">

</span><span class="c"># Caminho da imagem atualmente em uso no cliente</span><span class="w">
</span><span class="nv">$CurrentBackgroundImage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"C:\MDM\images\background.jpg"</span><span class="w">

</span><span class="c"># --- Criação do Diretório Temporário ---</span><span class="w">
</span><span class="n">md</span><span class="w"> </span><span class="nv">$TempImageDestinationFolder</span><span class="w"> </span><span class="nt">-ErrorAction</span><span class="w"> </span><span class="nx">SilentlyContinue</span><span class="w">

</span><span class="c"># Baixa a imagem mais recentes do Blob para a pasta temporária</span><span class="w">
</span><span class="n">Start-BitsTransfer</span><span class="w"> </span><span class="nt">-Source</span><span class="w"> </span><span class="nv">$BackgroundImageURL</span><span class="w"> </span><span class="nt">-Destination</span><span class="w"> </span><span class="s2">"</span><span class="nv">$TempBackgroundimage</span><span class="s2">"</span><span class="w">

</span><span class="c"># Pega o timestamp da imagem de fundo baixada do Blob</span><span class="w">
</span><span class="nv">$BlobBackgroundTimestamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-ItemProperty</span><span class="w"> </span><span class="s2">"</span><span class="nv">$TempBackgroundimage</span><span class="s2">"</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Select-Object</span><span class="w"> </span><span class="nt">-ExpandProperty</span><span class="w"> </span><span class="nx">LastWriteTime</span><span class="w">

</span><span class="c"># Pega o timestamp da imagem de fundo atualmente no cliente (se existir)</span><span class="w">
</span><span class="nv">$CurrentBackgroundTimestamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-ItemProperty</span><span class="w"> </span><span class="s2">"</span><span class="nv">$CurrentBackgroundImage</span><span class="s2">"</span><span class="w"> </span><span class="nt">-ErrorAction</span><span class="w"> </span><span class="nx">SilentlyContinue</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Select-Object</span><span class="w"> </span><span class="nt">-ExpandProperty</span><span class="w"> </span><span class="nx">LastWriteTime</span><span class="w">

</span><span class="c"># Verifica se os valores de registro esperados existem e estão corretos</span><span class="w">
</span><span class="nv">$RegDesktopPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-ItemPropertyValue</span><span class="w"> </span><span class="s2">"HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\PersonalizationCSP"</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s2">"DesktopImagePath"</span><span class="w"> </span><span class="nt">-ErrorAction</span><span class="w"> </span><span class="nx">SilentlyContinue</span><span class="w">
</span><span class="nv">$RegDesktopStatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-ItemPropertyValue</span><span class="w"> </span><span class="s2">"HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\PersonalizationCSP"</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s2">"DesktopImageStatus"</span><span class="w"> </span><span class="nt">-ErrorAction</span><span class="w"> </span><span class="nx">SilentlyContinue</span><span class="w">
</span><span class="nv">$RegDesktopUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-ItemPropertyValue</span><span class="w"> </span><span class="s2">"HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\PersonalizationCSP"</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s2">"DesktopImageUrl"</span><span class="w"> </span><span class="nt">-ErrorAction</span><span class="w"> </span><span class="nx">SilentlyContinue</span><span class="w">

</span><span class="c"># Remove a pasta temporária e seu conteúdo após a verificação</span><span class="w">
</span><span class="n">Remove-Item</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="nv">$TempImageDestinationFolder</span><span class="w"> </span><span class="nt">-Recurse</span><span class="w"> </span><span class="nt">-Force</span><span class="w"> </span><span class="nt">-ErrorAction</span><span class="w"> </span><span class="nx">SilentlyContinue</span><span class="w">

</span><span class="c"># Compara os timestamps e os valores do registro</span><span class="w">
</span><span class="kr">If</span><span class="w"> </span><span class="p">((</span><span class="nv">$CurrentBackgroundTimestamp</span><span class="w"> </span><span class="o">-eq</span><span class="w"> </span><span class="nv">$BlobBackgroundTimestamp</span><span class="p">)</span><span class="w"> </span><span class="o">-and</span><span class="w"> 
    </span><span class="p">(</span><span class="nv">$RegDesktopStatus</span><span class="w"> </span><span class="o">-eq</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">-and</span><span class="w"> 
    </span><span class="p">(</span><span class="nv">$RegDesktopPath</span><span class="w"> </span><span class="o">-eq</span><span class="w"> </span><span class="nv">$CurrentBackgroundImage</span><span class="p">)</span><span class="w"> </span><span class="o">-and</span><span class="w"> </span><span class="p">(</span><span class="nv">$RegDesktopUrl</span><span class="w"> </span><span class="o">-eq</span><span class="w"> </span><span class="nv">$CurrentBackgroundImage</span><span class="p">))</span><span class="w">
</span><span class="p">{</span><span class="w">
    </span><span class="c"># Se tudo estiver correto e atualizado, escreve "Detected" para o Intune</span><span class="w">
    </span><span class="n">Write-Host</span><span class="w"> </span><span class="s2">"Detected"</span><span class="w">
    </span><span class="kr">exit</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="kr">Else</span><span class="w"> 
</span><span class="p">{</span><span class="w">
    </span><span class="c"># Se algo estiver desatualizado ou incorreto, informa e sai com erro (força a reinstalação)</span><span class="w">
    </span><span class="n">Write-Host</span><span class="w"> </span><span class="s2">"Imagem desatualizada ou valores de registro ausentes/incorretos."</span><span class="w">
    </span><span class="kr">exit</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p><strong>Pontos importantes sobre este script:</strong></p><ul><li><strong>Consistência das URLs:</strong> As URLs no script de detecção DEVEM ser idênticas às usadas no script de instalação.<li><strong>Tratamento de Erros:</strong> O uso de <em>-ErrorAction SilentlyContinue</em> em <em>Get-ItemProperty</em> e <em>Remove-Item</em> é importante para evitar que o script falhe caso um arquivo ou chave de registro ainda não exista (por exemplo, na primeira execução).<li><strong>Lógica de Comparação:</strong> A condição <em>If</em> verifica se o <em>timestamp</em> da imagem local e remota são iguais e se todas as chaves de registro relevantes existem e têm os valores esperados. Qualquer desvio resulta na necessidade de reinstalação.<li><strong>Saída Padrão:</strong> O Intune espera que o script de detecção escreva algo na saída padrão (STDOUT) se a detecção for bem-sucedida. Por isso, é utilizado o <em>Write-Host</em> “Detected”.</ul><h2 id="parte-3-empacotando-e-implantando-via-intune"><span class="me-2">Parte 3: Empacotando e Implantando via Intune</span><a href="#parte-3-empacotando-e-implantando-via-intune" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Agora que temos os dois scripts (instalação e detecção), precisamos empacotar o script de instalação como um aplicativo Win32 e configurá-lo no Intune.</p><ul><li><strong>Salve os Scripts:</strong> Salve o script de instalação como <strong>install.ps1</strong> e o script de detecção como <strong>detect.ps1</strong>;<li><strong>Baixe a Ferramenta de Preparação:</strong> Obtenha a Ferramenta de Preparação de Conteúdo do Microsoft Win32 (IntuneWinAppUtil.exe) no GitHub oficial da Microsoft: <a href="https://github.com/microsoft/Microsoft-Win32-Content-Prep-Tool" target="_blank" rel="noopener noreferrer">Microsoft Win32 Content Prep Tool</a><li><strong>Empacote o Script de Instalação:</strong><li>Crie uma pasta de origem (ex: C:\Fonte_wallpaper) e coloque o install.ps1 dentro dela;<li>Crie uma pasta de saída (ex: C:\Build_wallpaper);<li>Abra o Prompt de Comando ou PowerShell, navegue até onde você salvou o IntuneWinAppUtil.exe e execute:<div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>IntuneWinAppUtil.exe <span class="nt">-c</span> C:<span class="se">\F</span>onte_wallpaper <span class="nt">-s</span> install.ps1 <span class="nt">-o</span> C:<span class="se">\B</span>uild_wallpaper
</pre></table></code></div></div><blockquote><p>Isso criará um arquivo <strong>install.intunewin</strong> na pasta de saída (C:\build_wallpaper). Este é o arquivo que você fará <em>upload</em> para o Intune.</p></blockquote></ul><p><a href="/assets/images/Post04/intunewin.png" class="popup img-link shimmer"><img src="/assets/images/Post04/intunewin.png" alt="Intunewin" loading="lazy"></a> <em>Obs: Criei a origem e a saída no mesmo diretório, mas recomendo que façam em diretórios separados, para mitigar possíveis erros.</em></p><p><strong>Agora, vamos criar o Aplicativo no Intune:</strong></p><ol><li>Vá para o portal do <a href="https://intune.microsoft.com/" target="_blank" rel="noopener noreferrer">Microsoft Intune</a>;<br /><li>Navegue até <strong>Apps</strong> &gt; <strong>Windows</strong> &gt; <strong>+ Create</strong>;<li>Tipo de aplicativo: <strong>Windows App (Win32)</strong>;<li>Informações do aplicativo: Selecione o arquivo <strong>install.intunewin</strong> que você criou;<li>Preencha os detalhes (Nome, Descrição, Categoria, etc.);</ol><p><strong>Programa:</strong></p><ul><li>Comando de instalação: <code class="language-plaintext highlighter-rouge">%SystemRoot%\system32\WindowsPowerShell\v1.0\powershell.exe -ExecutionPolicy Bypass -File .\install.ps1</code><li>Comando de desinstalação (Opcional): <code class="language-plaintext highlighter-rouge">%SystemRoot%\system32\WindowsPowerShell\v1.0\powershell.exe -ExecutionPolicy Bypass -File .\uninstall.ps1</code><ul><li>Você precisaria criar este uninstall.ps1 e empacotá-lo junto se quiser essa funcionalidade;<li>É recomendado ter um script que remova as chaves de registro, se necessário;</ul><li>Comportamento de instalação: <strong><em>System</em></strong> (para garantir permissões adequadas para escrever em HKLM e C:\MDM);<li>Requisitos: Especifique a arquitetura do SO (32/64 bits) e a versão mínima do Windows;<li>Regras de detecção:<ul><li>Formato das regras: Usar o script de detecção personalizado;<li>Arquivo de script: Faça upload do seu arquivo <strong>detect.ps1</strong>;<li>Executar script como processo de 32 bits em clientes de 64 bits: <strong>Não</strong> (geralmente);<li>Impor verificação de assinatura de script: <strong>Não</strong> (a menos que seus scripts estejam assinados);</ul><li>Dependências: (Geralmente não necessário para este caso);<li>Substituição: (Geralmente não necessário para este caso);<li>Atribuições: Atribua o aplicativo aos grupos de dispositivos desejados (ex: Todos os dispositivos Windows 10/11 Pro);<li>Revise e Crie: Verifique todas as configurações e crie o aplicativo;</ul><p><a href="/assets/images/Post04/config-app.png" class="popup img-link shimmer"><img src="/assets/images/Post04/config-app.png" alt="ConfigApp" loading="lazy"></a> <a href="/assets/images/Post04/detect.png" class="popup img-link shimmer"><img src="/assets/images/Post04/detect.png" alt="Detect" loading="lazy"></a></p><blockquote><p>. O Intune agora distribuirá o aplicativo Win32;<br /> . Na primeira vez, ele executará o <strong>install.ps1</strong>;<br /> . Em verificações subsequentes, ele executará o <strong>detect.ps1</strong>;<br /> . Se o detect.ps1 sair com <strong>código 0</strong> e escrever “Detected”, tudo certo;<br /> . Se sair com <strong>código 1</strong>, o Intune tentará executar o install.ps1 novamente para corrigir o estado (ou seja, baixar a imagem atualizada);</p></blockquote><h2 id="-conclusão"><span class="me-2">✅ Conclusão</span><a href="#-conclusão" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Embora a configuração inicial de papel de parede no <strong>Windows 10/11 Pro</strong> via Intune exija uma solução alternativa usando scripts e aplicativos Win32, a abordagem detalhada aqui oferece uma flexibilidade significativa.</p><p>Ao combinar um script de instalação robusto com um script de detecção inteligente baseado em timestamp de arquivo, você pode não apenas definir as imagens corporativas, mas também atualizá-las dinamicamente simplesmente alterando os arquivos de origem em seu repositório (como o Blob Storage), sem precisar tocar na configuração do Intune novamente.</p><p>Esta técnica demonstra o poder da automação com PowerShell e a flexibilidade da implantação de aplicativos Win32 no Intune para superar limitações e gerenciar configurações complexas de forma eficiente.</p><p>Espero que este tutorial ajude você a manter um ambiente de trabalho padronizado e atualizado para seus usuários do Windows 10/11 Pro!</p><p>Até a próxima! 🤘</p></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Atualizados recentemente</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/WallpaperIntune/">Definir Wallpaper via Intune com Atualização Dinâmica</a><li class="text-truncate lh-lg"> <a href="/posts/PhishingProtection/">Como habilitar o Enhanced Phishing Protection</a><li class="text-truncate lh-lg"> <a href="/posts/AuthenticationFlow/">Como se proteger contra abusos de Device Code Flow</a><li class="text-truncate lh-lg"> <a href="/posts/MicrosoftGraph/">Primeiros Passos com o Microsoft Graph no PowerShell</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/microsoft365/">Microsoft365</a> <a class="post-tag btn btn-outline-primary" href="/tags/endpoint/">Endpoint</a> <a class="post-tag btn btn-outline-primary" href="/tags/intune/">Intune</a> <a class="post-tag btn btn-outline-primary" href="/tags/azure-ad/">Azure AD</a> <a class="post-tag btn btn-outline-primary" href="/tags/conditional-access/">Conditional Access</a> <a class="post-tag btn btn-outline-primary" href="/tags/configuration/">Configuration</a> <a class="post-tag btn btn-outline-primary" href="/tags/device-code-flow/">Device Code Flow</a> <a class="post-tag btn btn-outline-primary" href="/tags/enhanced-phishing-protection/">Enhanced Phishing Protection</a> <a class="post-tag btn btn-outline-primary" href="/tags/entra-id/">Entra ID</a> <a class="post-tag btn btn-outline-primary" href="/tags/exchange/">Exchange</a></div></section></div></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>© <time>2025</time> <a href="https://github.com/antonio-luciano">Antonio Luciano</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Exceto onde indicado de outra forma, as postagens do blog neste site são licenciadas sob a Creative Commons Attribution 4.0 International (CC BY 4.0) License pelo autor." >Alguns direitos reservados.</span></p><p>Feito com <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> usando o tema <a data-bs-toggle="tooltip" data-bs-placement="top" title="v7.2.4" href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener" >Chirpy</a></p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center d-none"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/microsoft365/">Microsoft365</a> <a class="post-tag btn btn-outline-primary" href="/tags/endpoint/">Endpoint</a> <a class="post-tag btn btn-outline-primary" href="/tags/intune/">Intune</a> <a class="post-tag btn btn-outline-primary" href="/tags/azure-ad/">Azure AD</a> <a class="post-tag btn btn-outline-primary" href="/tags/conditional-access/">Conditional Access</a> <a class="post-tag btn btn-outline-primary" href="/tags/configuration/">Configuration</a> <a class="post-tag btn btn-outline-primary" href="/tags/device-code-flow/">Device Code Flow</a> <a class="post-tag btn btn-outline-primary" href="/tags/enhanced-phishing-protection/">Enhanced Phishing Protection</a> <a class="post-tag btn btn-outline-primary" href="/tags/entra-id/">Entra ID</a> <a class="post-tag btn btn-outline-primary" href="/tags/exchange/">Exchange</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div><aside id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">Uma nova versão do conteúdo está disponível.</p><button type="button" class="btn btn-primary" aria-label="Update"> atualização </button></div></aside><script> document.addEventListener('DOMContentLoaded', () => { SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{snippet}</p></article>', noResultsText: '<p class="mt-5">Oops! Nenhum resultado encontrado.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); }); </script>
